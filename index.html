<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø·Ø¹Ù… Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯ | ØªØ¬Ø±Ø¨Ø© Ø·Ø¹Ø§Ù… ÙØ±ÙŠØ¯Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #730101; --secondary: #ffe755; --accent: #ffe755; --white: #ffffff; --bg-soft: #fffdf2; --text-main: #2d0000; --text-muted: #8c7373; --glass: rgba(255, 255, 255, 0.9); --shadow: 0 10px 25px rgba(115, 1, 1, 0.1); --brand-red: #721812; --brand-yellow: #ffe755; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; -ms-overflow-style: none; scrollbar-width: none; }
        *::-webkit-scrollbar { display: none; }
        body { font-family: 'Cairo', sans-serif; margin: 0; background: var(--bg-soft); color: var(--text-main); overflow-x: hidden; line-height: 1.6; }
        #loader-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--white); z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .main-logo-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; }
        .main-logo-icon { width: 85px; height: 85px; background: var(--primary); border: 2px solid var(--accent); border-radius: 25px; display: flex; justify-content: center; align-items: center; box-shadow: 0 10px 20px rgba(115, 1, 1, 0.2); position: relative; }
        .main-logo-icon i { color: var(--accent); font-size: 40px; }
        .main-logo-text { margin-top: 12px; font-family: 'Cairo', sans-serif; font-weight: 900; font-size: 1.5rem; color: var(--primary); text-align: center; }
        header { background: var(--primary); color: var(--accent); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 5000; height: 75px; border-bottom: 1px solid var(--accent); box-shadow: var(--shadow); }
        .nav-icons { display: flex; gap: 12px; }
        .icon-btn { width: 45px; height: 45px; background: rgba(255, 231, 85, 0.1); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.03); cursor: pointer; position: relative; transition: 0.3s; }
        .icon-btn:active { transform: scale(0.9); }
        .icon-btn .badge { position: absolute; top: -5px; right: -5px; background: var(--accent); color: var(--primary); font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; border: 2px solid white; }
        .hero { margin: 20px; height: 180px; border-radius: 30px; background: linear-gradient(135deg, var(--primary) 0%, #4a0000 100%); display: flex; align-items: center; justify-content: center; color: var(--accent); text-align: center; position: relative; overflow: hidden; box-shadow: 0 15px 30px rgba(115, 1, 1, 0.2); }
        .hero::after { content: ''; position: absolute; width: 200px; height: 200px; background: rgba(255,231,85,0.1); border-radius: 50%; top: -50px; left: -50px; }
        .hero-content h1 { font-size: 1.8rem; margin: 0; font-weight: 900; }
        .hero-content p { font-size: 0.9rem; opacity: 0.9; margin: 5px 0 0; }
        .categories-container { display: flex; overflow-x: auto; padding: 10px 20px 25px; gap: 12px; scrollbar-width: none; }
        .cat-pill { padding: 10px 24px; background: var(--white); border-radius: 18px; white-space: nowrap; font-weight: 700; font-size: 0.95rem; color: var(--text-muted); box-shadow: var(--shadow); cursor: pointer; transition: 0.3s; border: 1px solid transparent; }
        .cat-pill.active { background: var(--accent); color: var(--primary); transform: translateY(-3px); box-shadow: 0 10px 20px rgba(255, 231, 85, 0.3); }
        .products-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 0 20px; }
        .product-card { background: var(--white); border-radius: 25px; overflow: hidden; box-shadow: var(--shadow); transition: 0.3s; display: flex; flex-direction: column; border: 1px solid rgba(0,0,0,0.02); }
        .product-card img { width: 100%; height: 140px; object-fit: cover; transition: 0.5s; }
        .product-card:hover img { transform: scale(1.05); }
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .product-info h3 { font-size: 1rem; margin: 0; font-weight: 800; color: var(--text-main); }
        .product-info .price-tag { background: #fff8e1; color: #ffa000; padding: 4px 10px; border-radius: 10px; font-size: 0.85rem; font-weight: 800; align-self: flex-start; margin: 8px 0; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 10px; border-radius: 14px; font-weight: 700; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
        .add-btn:hover { background: #5a0000; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 9999; justify-content: center; align-items: flex-end; }
        .modal-content { background: var(--white); width: 100%; max-width: 500px; border-radius: 35px 35px 0 0; padding: 30px 25px; position: relative; animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .close-handle { width: 50px; height: 5px; background: #e2e8f0; border-radius: 10px; margin: -15px auto 20px; }
        .modal-content.product-details { padding: 0; overflow: hidden; border-radius: 30px; background: #fff; max-width: 450px; }
        .modal-img-header { width: 100%; height: 200px; object-fit: cover; }
        .product-details-body { padding: 20px 25px; }
        .variant-card { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; margin-bottom: 12px; border: 2px solid #f1f5f9; border-radius: 18px; cursor: pointer; transition: 0.3s; }
        .variant-card.active { border-color: var(--primary); background: #f0f4ff; }
        .variant-card b { color: var(--text-main); font-size: 1.1rem; }
        .variant-card .price { color: var(--secondary); font-weight: 800; }
        .qty-wrapper { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 25px 0; background: #f8fafc; padding: 10px; border-radius: 20px; }
        .qty-btn { width: 45px; height: 45px; border-radius: 15px; border: none; background: white; color: var(--primary); font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; }
        #qtyCount { font-size: 1.5rem; font-weight: 900; color: var(--primary); min-width: 30px; text-align: center; }
        .modal-footer-ui { display: flex; gap: 15px; align-items: center; padding-top: 15px; border-top: 1px solid #f1f5f9; }
        .total-price-box { flex: 1; }
        .total-price-box span { font-size: 0.8rem; color: #64748b; display: block; }
        .total-price-box b { font-size: 1.4rem; color: var(--secondary); display: block; }
        .custom-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #f1f5f9; border-radius: 18px; background: #f8fafc; font-family: 'Cairo'; font-size: 1rem; transition: 0.3s; }
        .custom-input:focus { border-color: var(--primary); background: white; }
        .btn-action { background: var(--primary); color: white; width: 100%; padding: 16px; border: none; border-radius: 18px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 10px 20px rgba(26, 35, 126, 0.2); cursor: pointer; }
        .chat-btn { position: fixed; bottom: 95px; left: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, #d32f2f 0%, #8c0104 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; box-shadow: 0 10px 25px rgba(211, 47, 47, 0.4); z-index: 4000; cursor: pointer; border: 3px solid #fff; transition: all 0.4s; }
        .chat-btn::after { content: ''; position: absolute; width: 100%; height: 100%; background: inherit; border-radius: 50%; z-index: -1; animation: chatPulse 2s infinite; opacity: 0.5; }
        @keyframes chatPulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.6); opacity: 0; } }
        .chat-window { display: none; position: fixed; bottom: 100px; left: 25px; width: 320px; height: 450px; background: var(--white); border-radius: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); z-index: 4000; flex-direction: column; overflow: hidden; border: 1px solid #f1f5f9; animation: slideUp 0.3s; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8fafc; border-radius: 15px; margin-bottom: 10px; }
        #cartModal .modal-content { background: #f8fafc; border-radius: 30px 30px 0 0; padding: 25px; }
        .cart-header-ui { text-align: center; margin-bottom: 20px; }
        .cart-header-ui h2 { font-size: 1.4rem; color: #721812 !important; font-weight: 800; margin: 0; }
        .cart-item-card { background: #ffffff; border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #f1f5f9; border-right: 4px solid #721812; }
        .cart-item-info h4 { margin: 0; font-size: 1.05rem; color: #1e293b; font-weight: 700; }
        .cart-item-info span { font-size: 0.85rem; color: #94a3b8; display: block; margin-top: 4px; }
        .cart-item-price b { color: #721812; font-size: 1.1rem; display: block; }
        .remove-item-btn { color: #721812; opacity: 0.5; cursor: pointer; transition: 0.2s; font-size: 1.2rem; margin-right: 15px; }
        .remove-item-btn:hover { opacity: 1; }
        .cart-summary { background: #ffffff; border-radius: 20px; padding: 20px; margin-top: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.02); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .summary-row.total { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #e2e8f0; }
        .summary-row span { color: #721812; font-weight: 700; }
        .summary-row.total b { font-size: 1.6rem; color: #721812 !important; }
        .btn-confirm-order { background: #721812 !important; color: #ffe755 !important; border: 1px solid #ffe755; width: 100%; padding: 18px; border-radius: 20px; font-size: 1.1rem; font-weight: 800; cursor: pointer; margin-top: 15px; box-shadow: 0 10px 15px -3px rgba(114, 24, 18, 0.3) !important; display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.3s; }
        .footer-strip { background: var(--brand-red); border-top: 4px solid var(--brand-yellow); padding: 20px; color: var(--brand-yellow); text-align: center; margin-bottom: 75px; }
        .footer-strip .social-box { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .footer-strip .icon-item { width: 45px; height: 45px; background: rgba(255, 231, 85, 0.1); border: 1px solid var(--brand-yellow); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--brand-yellow); font-size: 1.2rem; transition: 0.3s; }
        .support-btn-red { position: fixed; bottom: 95px; left: 20px; width: 55px; height: 55px; background: #b71c1c; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.4rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 4000; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); height: 75px; display: flex; justify-content: space-around; align-items: center; z-index: 4500; box-shadow: 0 -10px 25px rgba(0,0,0,0.05); border-top: 1px solid rgba(226, 232, 240, 0.5); padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 5px; color: #94a3b8; text-decoration: none; font-size: 0.75rem; font-weight: 800; cursor: pointer; transition: 0.3s; position: relative; flex: 1; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.5rem; transition: 0.3s; }
        .cart-badge-nav { position: absolute; top: -5px; right: 25%; background: #e11d48; color: white; font-size: 0.7rem; padding: 2px 7px; border-radius: 10px; border: 2px solid white; font-weight: 900; }
        .profile-card { text-align: center; padding: 20px; }
        .profile-info-row { background: #f8fafc; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; border-right: 4px solid var(--brand-red); }
        .profile-info-row i { color: var(--brand-red); font-size: 1.2rem; }
    </style>
</head>
<body>
    <div id="loader-wrapper">
        <div class="main-logo-wrapper">
            <div class="main-logo-icon">
                <img src="792c5d7f-7b45-4e3f-9333-c69926ecaa3f (1).jpg" alt="Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯" style="width:100%; height:100%; object-fit:cover; border-radius:25px;">
            </div>
            <div class="main-logo-text">Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</div>
        </div>
    </div>
    <audio id="msgSound" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3"></audio>

    <header>
        <div class="nav-icons">
            <div class="icon-btn" onclick="openCart()"><i class="fas fa-shopping-bag"></i><span class="badge" id="cartCount">0</span></div>
            <div class="icon-btn" onclick="openMyOrders()"><i class="fas fa-history"></i></div>
            <div id="loginBtnNav" class="icon-btn" onclick="openAuth()"><i class="fas fa-user-plus"></i></div>
            <div id="userProfileNav" class="icon-btn" style="display:none;" onclick="openProfile()"><i class="fas fa-user-check"></i></div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-weight: 800; color: var(--primary); font-size: 1.2rem;">Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</span>
            <div class="main-logo-icon" style="width: 45px; height: 45px; border-radius: 12px; box-shadow: none;">
                <img src="792c5d7f-7b45-4e3f-9333-c69926ecaa3f (1).jpg" alt="Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">
            </div>
        </div>
    </header>

    <div class="hero">
        <div class="hero-content"><h1>Ø£ØµÙ„ Ø§Ù„Ø£ÙƒÙ„ Ø§Ù„Ù…ØµØ±ÙŠ ğŸ‡ªğŸ‡¬</h1><p>Ù…Ù†Ø° Ø¹Ø§Ù… 1958 ÙˆØ§Ù„Ø·Ø¹Ù… ÙŠØ­ÙƒÙŠ Ø§Ù„Ø­ÙƒØ§ÙŠØ©</p></div>
    </div>
    
    <div class="categories-container" id="categoryNav"></div>
    <div class="products-grid" id="productGrid"></div>
    
    <footer class="footer-strip">
        <div class="social-box">
            <a href="tel:15188" class="icon-item"><i class="fas fa-phone-alt"></i></a>
            <a href="https://wa.me/201015955557" class="icon-item"><i class="fab fa-whatsapp"></i></a>
            <a href="https://www.facebook.com/hatysheikhelbalad/" class="icon-item"><i class="fab fa-facebook-f"></i></a>
        </div>
        <div style="font-weight: 700; font-size: 0.9rem;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯ Â© 2024<br><small style="opacity: 0.7;">Ø¨ÙƒÙ„ Ø­Ø¨ Ù…Ù† Ø£Ø¬Ù„ÙƒÙ…</small></div>
    </footer>

    <div class="support-btn-red" onclick="toggleChat()"><i class="fas fa-headset"></i></div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="window.scrollTo({top: 0, behavior: 'smooth'})"><i class="fas fa-home"></i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
        <div class="nav-item" onclick="openMyOrders()"><i class="fas fa-file-invoice"></i><span>Ø·Ù„Ø¨Ø§ØªÙŠ</span></div>
        <div class="nav-item" onclick="openCart()"><i class="fas fa-shopping-bag"></i><span>Ø§Ù„Ø³Ù„Ø©</span><span class="cart-badge-nav" id="bottomCartCount">0</span></div>
        <div id="bottomProfileItem" class="nav-item" onclick="currentUser ? openProfile() : openAuth()"><i class="fas fa-user-circle"></i><span id="profileText">Ø­Ø³Ø§Ø¨ÙŠ</span></div>
    </nav>
    
    <div class="modal" id="authModal">
        <div class="modal-content">
            <div class="close-handle" onclick="closeModal('authModal')"></div>
            <h2 style="text-align:center; margin-bottom: 25px;">Ø§Ù†Ø¶Ù… Ù„Ø¹Ø§Ø¦Ù„Ø© Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</h2>
            <input type="text" id="regName" class="custom-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="tel" id="regPhone" class="custom-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <select id="regZone" class="custom-input">
                <option value="" disabled selected>Ø§Ø®ØªØ± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                <option value="Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ">Ø§Ù„Ù…Ø¹Ø§Ø¯ÙŠ</option>
                <option value="Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±">Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±</option>
                <option value="Ø§Ù„Ù‡Ø±Ù…">Ø§Ù„Ù‡Ø±Ù…</option>
                <option value="Ø§Ù„ØªØ¬Ù…Ø¹">Ø§Ù„ØªØ¬Ù…Ø¹</option>
            </select>
            <button id="gpsBtn" class="btn-action" style="background: #10b981; margin-bottom: 15px;" onclick="getUserLocation()"><i class="fas fa-location-arrow"></i> ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</button>
            <input type="text" id="regAddress" class="custom-input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø©/Ø§Ù„Ø´Ù‚Ø©)">
            <button class="btn-action" onclick="handleRegister()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>
    
    <div class="modal" id="optionsModal">
        <div class="modal-content product-details">
            <div class="close-handle" onclick="closeModal('optionsModal')" style="position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.8); z-index: 10;"></div>
            <img id="optProdImg" class="modal-img-header" src="" alt="">
            <div class="product-details-body">
                <h2 id="optProdName" style="margin: 0 0 15px 0; color: var(--primary); font-weight: 900;"></h2>
                <p style="color: #64748b; margin-bottom: 10px; font-weight: 600;">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹:</p>
                <div id="variantsList"></div>
                <textarea id="itemNote" class="custom-input" placeholder="Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø·Ù„Ø¨ Ø®Ø§ØµØŸ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="height: 80px; resize: none;"></textarea>
                <div class="qty-wrapper"><button class="qty-btn" onclick="updateQty(1)"><i class="fas fa-plus"></i></button><span id="qtyCount">1</span><button class="qty-btn" onclick="updateQty(-1)"><i class="fas fa-minus"></i></button></div>
                <div class="modal-footer-ui"><div class="total-price-box"><span>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span><b id="finalModalPrice">0 Ø¬.Ù…</b></div><button class="btn-action" style="flex: 2;" onclick="confirmAddToCart()">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button></div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="close-handle" onclick="closeModal('cartModal')"></div>
            <div class="cart-header-ui"><h2><i class="fas fa-shopping-basket"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2></div>
            <div id="cartItems" style="max-height: 350px; overflow-y: auto; padding: 5px;"></div>
            <div class="cart-summary">
                <div class="summary-row"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</span><span id="itemsCount">0</span></div>
                <div class="summary-row total"><span style="font-weight: 800; color: #64748b;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨</span><b id="cartTotal">0 Ø¬.Ù…</b></div>
                <button class="btn-confirm-order" onclick="submitOrder()">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ <i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="modal" id="successModal">
        <div class="modal-content" style="text-align:center; padding: 50px 25px;">
            <div style="width: 80px; height: 80px; background: #ecfdf5; color: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; margin: 0 auto 20px;"><i class="fas fa-check"></i></div>
            <h2>ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ!</h2>
            <p style="color: var(--text-muted);">Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù† Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø³ÙŠØµÙ„Ùƒ ÙÙŠ Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª.</p>
            <button class="btn-action" onclick="closeSuccessModal()">Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
    </div>

    <div class="modal" id="ordersModal">
        <div class="modal-content" style="max-height: 80vh;">
            <div class="close-handle" onclick="closeModal('ordersModal')"></div>
            <h2 style="text-align:center; margin-bottom: 20px;">ØªØ§Ø±ÙŠØ® Ø·Ù„Ø¨Ø§ØªÙƒ</h2>
            <div id="ordersList" style="overflow-y: auto;"></div>
        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="close-handle" onclick="closeModal('profileModal')"></div>
            <h2 style="text-align:center; color: var(--brand-red);">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h2>
            <div id="profileDetails" class="profile-card"></div>
            <button class="btn-action" style="background:#ccc; color:black; box-shadow:none;" onclick="logoutUser()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div class="chat-window" id="chatWindow">
        <div style="background:var(--primary); color:white; padding:18px; display:flex; justify-content:space-between; align-items: center;">
            <span style="font-weight: 800;"><i class="fas fa-headset"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</span>
            <i class="fas fa-times" onclick="toggleChat()" style="cursor: pointer;"></i>
        </div>
        <div id="chatBody" style="flex:1; padding:15px; overflow-y:auto; background:#f8fafc; display:flex; flex-direction:column; gap:8px;"></div>
        <div style="padding:15px; border-top:1px solid #f1f5f9; display:flex; gap: 8px;">
            <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ Ù‡Ù†Ø§..." style="flex:1; border:none; background:#f1f5f9; padding:12px; border-radius:12px; outline:none;">
            <button onclick="sendChat()" style="background:var(--primary); color:white; border:none; width:45px; height:45px; border-radius:12px;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyCYrGDMzUuQ1MiHmCy2OPId8yG07DyRT_g", authDomain: "sheikh-of-the-country.firebaseapp.com", projectId: "sheikh-of-the-country", storageBucket: "sheikh-of-the-country.firebasestorage.app", messagingSenderId: "767891906712", appId: "1:767891906712:web:1ee97ae642db1eb77b70ed", measurementId: "G-PLL1LDBRM1" };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.DB = {
            get: (path) => { return JSON.parse(localStorage.getItem('sheikh_app_' + path) || '{}'); },
            set: (path, val) => { set(ref(database, path), val); },
            push: (path, item) => { const newRef = push(ref(database, path)); set(newRef, item); return { key: newRef.key }; },
            update: (path, updates) => { update(ref(database, path), updates); },
            remove: (path) => { remove(ref(database, path)); }
        };

        const collections = ['products', 'categories', 'orders', 'chats', 'team_chat', 'users'];
        collections.forEach(col => {
            onValue(ref(database, col), (snapshot) => {
                const data = snapshot.val() || {};
                localStorage.setItem('sheikh_app_' + col, JSON.stringify(data));
                window.dispatchEvent(new Event('db_updated'));
                if (typeof refreshAll === 'function') refreshAll();
                if (typeof renderOrders === 'function') renderOrders();
                if (typeof refreshUI === 'function') refreshUI();
            });
        });

        // --- Logic ---
        let cart = [];
        let currentUser = JSON.parse(localStorage.getItem('sheikh_user_info'));
        let products = [];
        let selectedProductTemp = null;
        let selectedVariantTemp = null;
        let currentQty = 1;
        let tempCoords = null;

        function initData() {
            if(Object.keys(window.DB.get('products')).length === 0) {
                const def = [{name: "Ø´Ø§ÙˆØ±Ù…Ø§ Ù„Ø­Ù… Ø³ÙˆØ¨Ø±", cat: "Ø³Ù†Ø¯ÙˆØªØ´Ø§Øª", img: "https://images.unsplash.com/photo-1633321702518-7feccaf0ad44?auto=format&fit=crop&w=400", available: true, variants: [{bread: "ØµØ§Ø¬ Ø¹Ø§Ø¦Ù„ÙŠ", price: 95}, {bread: "ÙØ±Ù†Ø³Ø§ÙˆÙŠ", price: 80}]}, {name: "ÙˆØ¬Ø¨Ø© Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯", cat: "ÙˆØ¬Ø¨Ø§Øª", img: "https://images.unsplash.com/photo-1555939594-58d7cb561ad1?auto=format&fit=crop&w=400", available: true, variants: [{bread: "Ø±Ø¨Ø¹ ÙØ±Ø®Ø©", price: 140}, {bread: "Ù†Øµ ÙØ±Ø®Ø©", price: 210}]}];
                def.forEach(i => window.DB.push('products', i));
                window.DB.push('categories', {name: "Ø³Ù†Ø¯ÙˆØªØ´Ø§Øª"});
                window.DB.push('categories', {name: "ÙˆØ¬Ø¨Ø§Øª"});
            }
        }

        window.refreshUI = function() {
            products = Object.values(window.DB.get('products'));
            const cats = Object.values(window.DB.get('categories'));
            const nav = document.getElementById('categoryNav');
            nav.innerHTML = '<div class="cat-pill active" onclick="filterCat(\'all\',this)">Ø§Ù„ÙƒÙ„</div>';
            cats.forEach(c => { nav.innerHTML += `<div class="cat-pill" onclick="filterCat('${c.name}',this)">${c.name}</div>`; });
            loadProducts('all');
            
            if(currentUser) {
                setupUserUI();
                renderChatWindow(); // <--- Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§
            }
        }

        function loadProducts(c) {
            const g = document.getElementById('productGrid');
            g.innerHTML = '';
            products.forEach(p => {
                if ((c === 'all' || p.cat === c) && p.available) {
                    const minPrice = p.variants ? Math.min(...p.variants.map(v => v.price)) : 0;
                    g.innerHTML += `<div class="product-card"><img src="${p.img}"><div class="product-info"><h3>${p.name}</h3><div class="price-tag">${minPrice} Ø¬.Ù…</div><button class="add-btn" onclick="openOptions('${p.name}')"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button></div></div>`;
                }
            });
        }

        window.filterCat = function(c, b) { document.querySelectorAll('.cat-pill').forEach(x => x.classList.remove('active')); b.classList.add('active'); loadProducts(c); }

        window.openOptions = function(n) {
            selectedProductTemp = products.find(p => p.name === n);
            currentQty = 1;
            document.getElementById('optProdName').innerText = n;
            document.getElementById('optProdImg').src = selectedProductTemp.img;
            document.getElementById('qtyCount').innerText = currentQty;
            document.getElementById('itemNote').value = "";
            const l = document.getElementById('variantsList');
            l.innerHTML = '';
            selectedProductTemp.variants.forEach((v, i) => { l.innerHTML += `<div class="variant-card" onclick="selectVar(${i}, this)" id="var-${i}"><b>${v.bread}</b><span class="price">${v.price} Ø¬.Ù…</span></div>`; });
            selectVar(0, document.getElementById('var-0'));
            document.getElementById('optionsModal').style.display = 'flex';
        }

        window.selectVar = function(i, el) {
            document.querySelectorAll('.variant-card').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            selectedVariantTemp = selectedProductTemp.variants[i];
            calculateFinalPrice();
        }

        window.updateQty = function(val) { currentQty += val; if (currentQty < 1) currentQty = 1; document.getElementById('qtyCount').innerText = currentQty; calculateFinalPrice(); }
        function calculateFinalPrice() { if (selectedVariantTemp) { const total = selectedVariantTemp.price * currentQty; document.getElementById('finalModalPrice').innerText = total + " Ø¬.Ù…"; } }

        window.confirmAddToCart = function() {
            cart.push({ ...selectedProductTemp, variant: selectedVariantTemp, qty: currentQty, totalItemPrice: selectedVariantTemp.price * currentQty, note: document.getElementById('itemNote').value });
            updateCart();
            closeModal('optionsModal');
        }

        function updateCart() {
            const count = cart.length;
            document.getElementById('cartCount').innerText = count;
            document.getElementById('bottomCartCount').innerText = count;
            document.getElementById('itemsCount').innerText = count;
            const container = document.getElementById('cartItems');
            if (cart.length === 0) { container.innerHTML = `<div style="text-align:center; padding: 40px 0; color: #94a3b8;"><i class="fas fa-cart-plus" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.3;"></i><p>Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>`; return; }
            container.innerHTML = cart.map((item, index) => `<div class="cart-item-card"><div style="display: flex; align-items: center;"><i class="far fa-times-circle remove-item-btn" onclick="removeFromCart(${index})"></i><div class="cart-item-info"><h4>${item.qty} Ã— ${item.name}</h4><span>${item.variant.bread} ${item.note ? ' - ' + item.note : ''}</span></div></div><div class="cart-item-price"><b>${item.totalItemPrice} Ø¬</b></div></div>`).join('');
            const total = cart.reduce((sum, item) => sum + item.totalItemPrice, 0);
            document.getElementById('cartTotal').innerText = total + " Ø¬.Ù…";
        }

        window.removeFromCart = function(index) { cart.splice(index, 1); updateCart(); }
        window.openCart = function() { document.getElementById('cartModal').style.display = 'flex'; }
        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }
        window.openAuth = function() { document.getElementById('authModal').style.display = 'flex'; }
        
        window.openProfile = function() {
            if(!currentUser) return openAuth();
            const details = document.getElementById('profileDetails');
            details.innerHTML = `<div class="profile-info-row"><i class="fas fa-user"></i><div style="text-align:right"><small style="display:block; color:#94a3b8">Ø§Ù„Ø§Ø³Ù…</small><b>${currentUser.name}</b></div></div><div class="profile-info-row"><i class="fas fa-phone"></i><div style="text-align:right"><small style="display:block; color:#94a3b8">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</small><b>${currentUser.phone}</b></div></div><div class="profile-info-row"><i class="fas fa-map-marker-alt"></i><div style="text-align:right"><small style="display:block; color:#94a3b8">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</small><b>${currentUser.address}</b></div></div>`;
            document.getElementById('profileModal').style.display = 'flex';
        }

        window.logoutUser = function() { if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) { localStorage.removeItem('sheikh_user_info'); location.reload(); } }
        window.handleRegister = function() {
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const zone = document.getElementById('regZone').value;
            const addr = document.getElementById('regAddress').value;
            if(name && phone && zone && addr) { currentUser = { name, phone, address: `${zone} - ${addr}`, zone, coords: tempCoords }; localStorage.setItem('sheikh_user_info', JSON.stringify(currentUser)); setupUserUI(); closeModal('authModal'); } else { alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
        }
        function setupUserUI() { document.getElementById('loginBtnNav').style.display = 'none'; document.getElementById('userProfileNav').style.display = 'flex'; }

        window.submitOrder = function() {
            if(!currentUser) return openAuth();
            if(cart.length === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");
            const orderData = { customerName: currentUser.name, phone: currentUser.phone, address: currentUser.address, items: cart, total: document.getElementById('cartTotal').innerText, status: 'pending', timestamp: Date.now() };
            window.DB.push('orders', orderData);
            cart = []; updateCart(); closeModal('cartModal'); document.getElementById('successModal').style.display = 'flex';
        }

        window.openMyOrders = function() {
            if(!currentUser) return openAuth();
            const orders = Object.values(window.DB.get('orders')).filter(o => o.phone === currentUser.phone);
            const list = document.getElementById('ordersList');
            list.innerHTML = orders.reverse().map(o => `<div class="cart-item" style="flex-direction:column; align-items:flex-start;"><div style="display:flex; justify-content:space-between; width:100%; margin-bottom:5px;"><b style="color:var(--primary)">${o.total}</b><span style="font-size:0.8rem; background:#eee; padding:2px 8px; border-radius:5px;">${o.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°'}</span></div><small style="color:var(--text-muted)">${new Date(o.timestamp).toLocaleString('ar-EG')}</small></div>`).join('') || "<p style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>";
            document.getElementById('ordersModal').style.display = 'flex';
        }
        window.closeSuccessModal = function() { closeModal('successModal'); openMyOrders(); }
        window.getUserLocation = function() {
            const btn = document.getElementById('gpsBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...';
            navigator.geolocation.getCurrentPosition((pos) => { tempCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude }; document.getElementById('regAddress').value = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© Ø¹Ø¨Ø± GPS âœ…"; btn.style.background = "#059669"; btn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­'; }, () => { alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ"); btn.innerHTML = '<i class="fas fa-location-arrow"></i> Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'; });
        }
        window.sendChat = function() {
            const input = document.getElementById('chatInput');
            const txt = input.value.trim();

            // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
            if (!currentUser) {
                alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„ÙƒÙŠ Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ");
                toggleChat(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´Ø§Øª
                openAuth();   // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                return;
            }

            if(txt) {
                // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const allChats = window.DB.get('chats') || {};
                const userPhone = currentUser.phone; // Ù†Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙƒÙ…Ø¹Ø±Ù

                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù„Ùˆ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                if (!allChats[userPhone]) {
                    allChats[userPhone] = {};
                }

                // 3. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                const msgId = 'msg_' + Date.now();
                allChats[userPhone][msgId] = {
                    sender: 'customer', // Ø§Ù„Ù…Ø±Ø³Ù„ Ù‡Ùˆ Ø§Ù„Ø²Ø¨ÙˆÙ†
                    name: currentUser.name,
                    text: txt,
                    timestamp: Date.now()
                };

                // 4. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠÙ†Ù‚ØµÙƒ)
                window.DB.set('chats', allChats);

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø®Ø§Ù†Ø©
                input.value = '';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹
                renderChatWindow();
            }
        }
        window.renderChatWindow = function() {
            if (!currentUser) return; // Ù„Ùˆ Ù…Ø´ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù…ÙÙŠØ´ Ø´Ø§Øª

            const body = document.getElementById('chatBody');
            body.innerHTML = ''; // Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø¬Ø¯ÙŠØ¯
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙÙ‚Ø·
            const allChats = window.DB.get('chats') || {};
            const myMsgs = allChats[currentUser.phone] || {};

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ¹Ø±Ø¶Ù‡Ø§
            Object.values(myMsgs).sort((a,b) => a.timestamp - b.timestamp).forEach(m => {
                const isMe = m.sender === 'customer';
                // ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ø­Ù…Ø±Ø§Ø¡ Ù„ÙŠ ÙˆØ¨ÙŠØ¶Ø§Ø¡ Ù„Ù„Ø£Ø¯Ù…Ù†)
                const style = isMe 
                    ? "background:var(--primary); color:white; padding:10px 15px; border-radius:15px 15px 0 15px; align-self:flex-end; max-width:80%; margin-bottom:5px;" 
                    : "background:#e2e8f0; color:#333; padding:10px 15px; border-radius:15px 15px 15px 0; align-self:flex-start; max-width:80%; margin-bottom:5px;";
                
                body.innerHTML += `<div style="${style}">${m.text}</div>`;
            });
            
            // Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
            body.scrollTop = body.scrollHeight;
        }
        window.toggleChat = function() { 
            const w = document.getElementById('chatWindow'); 
            const isOpen = w.style.display === 'flex';
            w.style.display = isOpen ? 'none' : 'flex';
            
            if (!isOpen && currentUser) {
                renderChatWindow(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            }
        }

        window.onload = () => { initData(); refreshUI(); setTimeout(() => { document.getElementById('loader-wrapper').style.opacity = '0'; setTimeout(() => document.getElementById('loader-wrapper').style.display = 'none', 500); }, 1200); };
    </script>
</body>
</html>
