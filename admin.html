<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯ - Ø§Ù„Ù…Ø·ÙˆØ± (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">

    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCYrGDMzUuQ1MiHmCy2OPId8yG07DyRT_g",
        authDomain: "sheikh-of-the-country.firebaseapp.com",
        projectId: "sheikh-of-the-country",
        storageBucket: "sheikh-of-the-country.firebasestorage.app",
        messagingSenderId: "767891906712",
        appId: "1:767891906712:web:1ee97ae642db1eb77b70ed",
        measurementId: "G-PLL1LDBRM1"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      window.db = db;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbPush = push;
      window.dbOnValue = onValue;
      window.dbUpdate = update;
      window.dbRemove = remove;
      window.dbGet = get;

      console.log("Firebase Connected Successfully! âœ…");
      startSystem();
    </script>

    <style>
        :root {
            --primary-red: #721812;
            --primary-yellow: #ffe755;
            --white: #ffffff;
            --bg-main: #fffcf0;
            --blue: #18248b; --red: #8c0104; --green: #27ae60; --gray: #f0f2f5;
        }

        body { margin: 0; font-family: 'Cairo', sans-serif; display: flex; background: var(--gray); height: 100vh; overflow: hidden; }

        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #18248b 0%, #0c144d 100%);
            display: flex; justify-content: center; align-items: center; z-index: 5000;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); width: 100%; max-width: 400px; text-align: center;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .login-card h1 { color: #18248b; font-size: 1.8rem; margin-bottom: 30px; font-weight: 800; }

        .input-group { position: relative; margin-bottom: 20px; text-align: right; }
        .input-group i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #18248b; opacity: 0.6; }

        #loginScreen input {
            width: 100%; padding: 14px 45px 14px 15px; border: 2px solid #eee;
            border-radius: 10px; font-size: 1rem; transition: 0.3s; box-sizing: border-box; background: #f9f9f9;
        }

        #loginScreen input:focus { border-color: #8c0104; background: #fff; outline: none; box-shadow: 0 0 8px rgba(140, 1, 4, 0.1); }

        #loginScreen button {
            width: 100%; padding: 14px; background: #8c0104; color: white; border: none;
            border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(140, 1, 4, 0.3);
        }

        .sidebar { width: 260px; background: var(--primary-red); color: white; padding: 20px 10px; display: flex; flex-direction: column; border-left: 5px solid var(--primary-yellow); }
        .menu-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; position: relative; color: var(--primary-yellow); }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-right: 4px solid var(--primary-yellow); }
        
        .badge-counter { background: var(--primary-yellow); color: var(--primary-red); border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; position: absolute; left: 15px; display: none; font-weight: bold; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .main { flex: 1; padding: 25px; overflow-y: auto; background: var(--bg-main); }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }

        .form-box { background: white; padding: 25px; border-radius: 10px; max-width: 900px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .users-table { width: 100%; border-collapse: collapse; background: white; margin-top: 0; }
        .users-table thead tr { background-color: var(--primary-red); color: var(--primary-yellow); }
        .users-table th, .users-table td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }

        .order-column { flex: 1; background: #ffffff; border-radius: 20px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.03); border: 1px solid #edf2f7; display: flex; flex-direction: column; height: 80vh; }
        .column-header { padding: 15px; border-radius: 15px; margin-bottom: 15px; font-weight: 800; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .header-new { background: #fff5f5; color: #c53030; border-right: 5px solid #c53030; }
        .header-process { background: #ebf8ff; color: #2b6cb0; border-right: 5px solid #2b6cb0; }

        .order-card.modern { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: all 0.3s ease; cursor: pointer; position: relative; }
        .order-card.modern:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.05); }
        .order-card.shake-screen { animation: shake 0.5s infinite; border: 2px solid var(--red); }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        .team-chat-container { display: flex; flex-direction: column; height: 75vh; background: #e5ddd5; border-radius: 15px; overflow: hidden; position: relative; }
        .team-chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .team-msg { padding: 10px 15px; border-radius: 15px; max-width: 75%; position: relative; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .team-msg.mine { background: #dcf8c6; align-self: flex-end; }
        .team-msg.others { background: white; align-self: flex-start; }

        .stickers-panel { height: 0; background: white; transition: 0.3s; overflow: hidden; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .stickers-panel.open { height: 160px; padding: 10px; border-top: 1px solid #ccc; overflow-y: auto; }
        .sticker-item { cursor: pointer; border-radius: 5px; transition: 0.2s; text-align: center; height: 70px; display: flex; align-items: center; justify-content: center; background: #eee; }

        .dash-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: white; padding: 20px; border-radius: 15px; border-bottom: 4px solid var(--primary-red); text-align: center; transition: 0.3s; }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--primary-red); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 20px; width: 550px; max-width: 95%; box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden; }
        .modal-header { background: var(--primary-red); color: var(--primary-yellow); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .order-detail-card { background: #fffdf2; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-right: 5px solid #730101; }
        .btn-blue { background: var(--primary-red); color: var(--primary-yellow); border: 1px solid var(--primary-yellow); padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head><body>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" loop></audio>

    <!-- 1. Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© -->
    <div id="loginScreen">
        <div class="login-card">
            <div style="width:100px; height:100px; margin: 0 auto 20px; border-radius:50%; overflow:hidden; border:4px solid var(--blue);">
                <img src="792c5d7f-7b45-4e3f-9333-c69926ecaa3f (1).jpg" alt="Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <h1>Ø¨ÙˆØ§Ø¨Ø© Ù…ÙˆØ¸ÙÙŠ Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</h1>
            <div class="input-group">
                <i class="fas fa-user-tie"></i>
                <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
            </div>
            <div class="input-group">
                <i class="fas fa-key"></i>
                <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <button id="loginBtn">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            <p style="margin-top: 25px; color: #888; font-size: 0.9rem;">Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ± - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2026</p>
        </div>
    </div>

    <!-- 2. Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ (Sidebar) -->
    <div class="sidebar">
        <h2 id="adminNameDisplay">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
        
        <div class="menu-item active" onclick="nav('live-orders')">
            <i class="fas fa-bolt"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© 
            <span class="badge-counter" id="orderBadge" style="display:none">0</span>
        </div>
        
        <div class="menu-item" onclick="nav('dashboard')">
            <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
        </div>
        
        <div class="menu-item" onclick="nav('team-chat-section')">
            <i class="fas fa-comments"></i> Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚
        </div>
        
        <!-- Ù‚Ø³Ù… ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙ‚Ø· -->
        <div class="admin-only">
            <div class="menu-item" onclick="nav('reports')">
                <i class="fas fa-file-invoice-dollar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            </div>
            <div class="menu-item" onclick="nav('products')">
                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
            </div>
            <div class="menu-item" onclick="nav('manage-products')">
                <i class="fas fa-tasks"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ
            </div>
            <div class="menu-item" onclick="nav('users')">
                <i class="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            </div>
        </div>

        <div class="menu-item" onclick="nav('customer-chat')">
            <i class="fas fa-headset"></i> Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            <span class="badge-counter" id="custBadge" style="display:none">0</span>
        </div>

        <div class="menu-item" onclick="logoutStaff()" style="margin-top:auto; background:rgba(0,0,0,0.3); border-top: 1px solid gold;">
            <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </div>
    </div>

    <!-- 3. Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Content) -->
    <div class="main">

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© -->
        <div id="live-orders" class="section active">
            <div style="display:flex; gap:30px; height:80vh;">
                <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
                <div class="order-column">
                    <div class="column-header header-new">
                        <i class="fas fa-star"></i> Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù… ØªØ±Ø§Ø¬Ø¹)
                    </div>
                    <div id="newOrdersList" style="flex:1; overflow-y:auto;"></div>
                </div>

                <!-- Ø¹Ù…ÙˆØ¯ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ± -->
                <div class="order-column">
                    <div class="column-header header-process">
                        <i class="fas fa-fire-alt"></i> ÙÙŠ Ø§Ù„Ù…Ø·Ø¨Ø® (Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±)
                    </div>
                    <div id="processingOrdersList" style="flex:1; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div id="dashboard" class="section">
            <div class="dash-container" id="adminStatsBar">
                <div class="dash-card">
                    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                    <div id="todaySales" class="stat-val">0 Ø¬</div>
                </div>
                <div class="dash-card">
                    <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
                    <div id="todayCount" class="stat-val">0</div>
                </div>
                <div class="dash-card">
                    <div>Ø·Ù„Ø¨Ø§Øª Ù…Ù„ØºÙŠØ© / Ù…Ø±ÙÙˆØ¶Ø©</div>
                    <div id="canxCount" class="stat-val" style="color:var(--red)">0</div>
                </div>
            </div>

            <div class="form-box" style="display:flex; gap:15px; align-items:flex-end;">
                <div style="flex:2">
                    <label>Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label>
                    <input type="text" id="histSearch" onkeyup="filterHistory()" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." style="margin:0">
                </div>
                <div style="flex:1">
                    <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="statusFilter" onchange="filterHistory()" style="margin:0">
                        <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                        <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                        <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                    </select>
                </div>
                <button class="btn-blue" onclick="filterHistory()" style="height:45px">ØªØ­Ø¯ÙŠØ« <i class="fas fa-sync"></i></button>
            </div>

            <table class="users-table">
                <thead>
                    <tr><th>#</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th></tr>
                </thead>
                <tbody id="historyTBody"></tbody>
            </table>
        </div>

        <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
        <div id="reports" class="section">
            <div class="form-box">
                <h3><i class="fas fa-chart-line"></i> Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                <div style="display:flex; gap:20px; margin:20px 0;">
                    <div style="flex:1"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label><input type="date" id="repStart"></div>
                    <div style="flex:1"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label><input type="date" id="repEnd"></div>
                </div>
                <button class="btn-blue" onclick="generateReport()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
            
            <div id="reportBox" style="display:none; background:white; padding:35px; border-radius:25px; box-shadow:var(--shadow); margin-top:20px;">
                <h2 style="text-align:center; color:var(--primary-red)">ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ù…Ø¨ÙŠØ¹Ø§Øª Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</h2>
                <table class="users-table">
                    <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</th></tr></thead>
                    <tbody id="reportTBody"></tbody>
                </table>
                <div style="margin-top:30px; padding:20px; background:#fffcf0; border-radius:15px; border:1px dashed var(--primary-red);">
                    <h3 style="margin:0; color:var(--primary-red)">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„ÙØªØ±Ø©: <span id="grandTotal">0</span> Ø¬.Ù…</h3>
                </div>
            </div>
        </div>

        <!-- Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø·ÙˆØ± -->
        <div id="team-chat-section" class="section">
            <div class="team-chat-container">
                <div class="team-chat-msgs" id="teamChatBox"></div>
                
                <div class="stickers-panel" id="stickersPanel">
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/m8WGPrQ3qVMAAAAM/cat-dance.gif')"><img src="https://media.tenor.com/m8WGPrQ3qVMAAAAM/cat-dance.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/NBX02q0mQf0AAAAM/laughing.gif')"><img src="https://media.tenor.com/NBX02q0mQf0AAAAM/laughing.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/7Y6o7Y6oAAAAM/thumbs-up.gif')"><img src="https://media.tenor.com/7Y6o7Y6oAAAAM/thumbs-up.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/Z8vXf6o8XkAAAAAM/funny-animals.gif')"><img src="https://media.tenor.com/Z8vXf6o8XkAAAAAM/funny-animals.gif"></div>
                </div>

                <div style="padding:20px; background:white; display:flex; gap:15px; align-items:center; border-top:1px solid #ddd;">
                    <button onclick="toggleStickers()" style="background:none; border:none; font-size:1.8rem; cursor:pointer">ğŸ˜Š</button>
                    <input type="text" id="tMsgInp" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ø²Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚..." style="margin:0; flex:1">
                    <button class="btn-blue" onclick="sendTeamMsg()">Ø¥Ø±Ø³Ø§Ù„ <i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ù†ÙŠÙˆ (Ø³ÙŠØªÙ… Ø¥ÙƒÙ…Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§ Ø³ÙƒØ±ÙŠØ¨Øª ÙÙŠ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù‚Ø§Ø¯Ù…) -->
    </div><!-- ØªÙƒÙ…Ù„Ø© Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù€ HTML Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© -->
        <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
        <div id="products" class="section">
            <div class="form-box">
                <h3><i class="fas fa-hamburger"></i> Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ù†ÙŠÙˆ</h3>
                <label>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:</label><input type="text" id="pName">
                <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØµÙ†Ù:</label><input type="text" id="pImg">
                <label>Ø§Ù„ØªØµÙ†ÙŠÙ:</label><select id="pCatSelect"></select>
                
                <div style="background:#f9f9f9; padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid #ddd;">
                    <h4>Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£Ø­Ø¬Ø§Ù… ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="vLabel" placeholder="Ø§Ù„ÙˆØµÙ (Ù…Ø«Ù„Ø§Ù‹: Ø®Ø¨Ø² ØµØ§Ø¬)">
                        <input type="number" id="vPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        <button class="btn-blue" onclick="addVToTemp()">Ø£Ø¶Ù Ø§Ù„Ø³Ø¹Ø± <i class="fas fa-plus"></i></button>
                    </div>
                    <div id="tempVDisplay" style="margin-top:15px; font-weight:bold; color:var(--primary-red); border-top:1px dashed #ccc; padding-top:10px;"></div>
                </div>
                <button class="btn-blue" style="width:100%; font-size:1.2rem;" onclick="finalSaveProduct()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ù…Ù†ÙŠÙˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ -->
        <div id="manage-products" class="section">
            <h3><i class="fas fa-tasks"></i> Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªÙˆÙØ± Ø§Ù„Ø£ØµÙ†Ø§Ù (ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚)</h3>
            <table class="users-table">
                <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                <tbody id="managePBody"></tbody>
            </table>
        </div>

        <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="users" class="section">
            <div class="form-box">
                <h3><i class="fas fa-user-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label><input type="text" id="uFullName">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label><input type="password" id="uPassInput">
                <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</label>
                <select id="uRoleSelect">
                    <option value="receiver">ÙƒØ§Ø´ÙŠØ± / Ù…ÙˆØ¸Ù Ù…Ø·Ø¨Ø®</option>
                    <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù… (ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§Ù…Ù„Ø©)</option>
                </select>
                <button class="btn-blue" onclick="addNewStaff()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            </div>
            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h3>
            <table class="users-table">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø­Ø°Ù</th></tr></thead>
                <tbody id="staffTableBody"></tbody>
            </table>
        </div>

        <!-- Ù‚Ø³Ù… Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
        <div id="customer-chat" class="section">
            <div class="chat-layout">
                <div class="chat-list" id="custChatList"></div>
                <div class="chat-area">
                    <div id="custChatHeader" style="padding:15px; background:white; font-weight:bold; border-bottom:1px solid #ddd; display:none; color:var(--blue);">
                        Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„: <span id="activeCustName"></span>
                    </div>
                    <div id="custChatBox" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px;">
                        <div style="text-align:center; color:#999; margin-top:50px;">
                            <i class="fas fa-comments" style="font-size:3rem; opacity:0.2;"></i><br>Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø¯
                        </div>
                    </div>
                    <div id="custChatFooter" style="padding:20px; background:white; display:none; gap:15px; border-top:1px solid #eee;">
                        <input type="text" id="custReplyInp" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." style="margin:0; flex:1">
                        <button class="btn-blue" onclick="sendReplyToCust()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ <i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- Ù†Ù‡Ø§ÙŠØ© Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ -->
    <div class="modal" id="orderModal"></div>

    <script>
        // --- 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¯ÙˆØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        const DB = {
            push: (path, item) => window.dbPush(window.dbRef(window.db, path), item),
            update: (path, updates) => window.dbUpdate(window.dbRef(window.db, path), updates),
            remove: (path) => window.dbRemove(window.dbRef(window.db, path)),
            listen: (path, callback) => window.dbOnValue(window.dbRef(window.db, path), (snap) => callback(snap.val() || {}))
        };

        let currentUser = JSON.parse(localStorage.getItem('sheikh_staff_user'));
        let allOrdersData = {};
        let allStaffData = {};
        let tempVariantsBuffer = [];
        let activeChatPhone = null;

        // --- 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ·ÙˆØ± ---
        document.getElementById('loginBtn').onclick = function() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();

            // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            if (u === 'admin' && p === '123') {
                proceedToLogin({ name: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', role: 'admin', key: 'super_admin' });
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Firebase
            let isFound = false;
            Object.entries(allStaffData).forEach(([key, staff]) => {
                if (staff.name === u && staff.pass === p) {
                    proceedToLogin({ ...staff, key: key });
                    isFound = true;
                }
            });

            if (!isFound) alert("âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
        };

        function proceedToLogin(user) {
            currentUser = user;
            localStorage.setItem('sheikh_staff_user', JSON.stringify(user));
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminNameDisplay').innerText = user.name;
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
            if (user.role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                if(document.getElementById('adminStatsBar')) document.getElementById('adminStatsBar').style.display = 'none';
            }
        }

        window.logoutStaff = () => { localStorage.removeItem('sheikh_staff_user'); location.reload(); };

        window.nav = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');
        };

        // --- 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø­ÙŠØ©) ---
        function startSystem() {
            if (currentUser) proceedToLogin(currentUser);

            // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            DB.listen('users', data => {
                allStaffData = data;
                renderStaffTable();
            });

            // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª
            DB.listen('orders', data => {
                allOrdersData = data;
                renderLiveOrders();
                filterHistory();
            });

            // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚
            DB.listen('team_chat', data => renderTeamChatBox(data));

            // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            DB.listen('chats', data => renderCustChatSidebar(data));

            // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª
            DB.listen('products', data => renderManageMenu(data));
            DB.listen('categories', data => {
                const sel = document.getElementById('pCatSelect');
                sel.innerHTML = '<option disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>';
                Object.values(data).forEach(c => sel.innerHTML += `<option value="${c.name}">${c.name}</option>`);
            });
        }

        // --- 4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© ---
        function renderLiveOrders() {
            const newList = document.getElementById('newOrdersList');
            const procList = document.getElementById('processingOrdersList');
            newList.innerHTML = ''; procList.innerHTML = '';
            let unreadCount = 0;

            Object.entries(allOrdersData).reverse().forEach(([id, o]) => {
                if (o.status === 'completed' || o.status === 'cancelled') return;

                const cardHtml = `
                    <div class="order-card modern" onclick="openFullOrder('${id}')">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <b style="color:var(--blue)">Ø±Ù‚Ù… #${id.slice(-4)}</b>
                            <small style="color:#888">${new Date(o.timestamp).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'})}</small>
                        </div>
                        <h4 style="margin:5px 0">${o.customerName}</h4>
                        <div style="font-size:0.9rem; color:#666;"><i class="fas fa-map-marker-alt"></i> ${o.address.substring(0,30)}...</div>
                        <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center; border-top:1px dashed #eee; padding-top:10px;">
                            <span class="order-price-tag">${o.total} Ø¬</span>
                            <span style="font-size:0.75rem; background:var(--bg-main); padding:4px 10px; border-radius:8px; font-weight:bold;">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
                        </div>
                    </div>`;

                if (o.status === 'pending' || o.status === 'new') {
                    newList.innerHTML += cardHtml;
                    if (!o.seenByAdmin) unreadCount++;
                } else if (o.status === 'processing') {
                    procList.innerHTML += cardHtml;
                }
            });

            // Ø¬Ø±Ø³ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            const sfx = document.getElementById('alarmSound');
            if (unreadCount > 0) {
                document.getElementById('orderBadge').innerText = unreadCount;
                document.getElementById('orderBadge').style.display = 'block';
                sfx.play().catch(()=>{});
            } else {
                document.getElementById('orderBadge').style.display = 'none';
                sfx.pause(); sfx.currentTime = 0;
            }
        }

        window.openFullOrder = (id) => {
            const o = allOrdersData[id];
            DB.update(`orders/${id}`, { seenByAdmin: true });
            
            const modal = document.getElementById('orderModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ #${id.slice(-4)}</span><i class="fas fa-receipt"></i></div>
                    <div style="padding:25px;">
                        <div class="order-detail-card">
                            <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${o.customerName} <br>
                            <b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${o.phone} <br>
                            <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${o.address}
                        </div>
                        <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                            <thead style="background:#f9f9f9;"><tr><th style="padding:10px; text-align:right;">Ø§Ù„ØµÙ†Ù</th><th style="padding:10px; text-align:left;">Ø§Ù„Ø³Ø¹Ø±</th></tr></thead>
                            <tbody>
                                ${o.items.map(i => `<tr style="border-bottom:1px solid #eee"><td style="padding:12px"><b>${i.count}x</b> ${i.name} <br><small style="color:#888">${i.variant?i.variant.bread:''}</small></td><td style="text-align:left">${i.price} Ø¬</td></tr>`).join('')}
                            </tbody>
                        </table>
                        <h2 style="text-align:center; color:var(--primary-red); margin-bottom:25px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total} Ø¬.Ù…</h2>
                        <div style="display:flex; gap:15px;">
                            ${(o.status==='pending'||o.status==='new') ? 
                                `<button class="btn-blue" style="background:#27ae60; flex:2" onclick="changeStatus('${id}','processing')">Ù‚Ø¨ÙˆÙ„ ÙˆØªØ¬Ù‡ÙŠØ² <i class="fas fa-check"></i></button>
                                 <button class="btn-blue" style="background:#c0392b; flex:1" onclick="rejectProcess('${id}')">Ø±ÙØ¶ <i class="fas fa-times"></i></button>` :
                                `<button class="btn-blue" style="background:var(--primary-red); width:100%" onclick="changeStatus('${id}','completed')">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ <i class="fas fa-truck"></i></button>`
                            }
                        </div>
                    </div>
                    <button onclick="closeOModal()" style="width:100%; padding:20px; border:none; background:#eee; cursor:pointer; font-weight:bold; font-size:1.1rem;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
                </div>`;
            modal.style.display = 'flex';
        };

        window.changeStatus = (id, s) => { DB.update(`orders/${id}`, { status: s, handledBy: currentUser.name }); closeOModal(); };
        window.rejectProcess = (id) => { const r = prompt("Ù…Ø§ Ù‡Ùˆ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ØŸ"); if(r) { DB.update(`orders/${id}`, { status: 'cancelled', adminReason: r, handledBy: currentUser.name }); closeOModal(); } };
        window.closeOModal = () => document.getElementById('orderModal').style.display = 'none';

        // --- 5. Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ---
        function filterHistory() {
            const search = document.getElementById('histSearch').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const body = document.getElementById('historyTBody'); body.innerHTML = '';
            
            let sales = 0, count = 0, canx = 0;

            Object.entries(allOrdersData).reverse().forEach(([id, o]) => {
                const matchSearch = o.phone.includes(search) || o.customerName.toLowerCase().includes(search);
                const matchStatus = (status === 'all' || o.status === status);

                if (matchSearch && matchStatus) {
                    if (o.status === 'completed') { sales += parseInt(o.total); count++; }
                    if (o.status === 'cancelled') canx++;

                    body.innerHTML += `
                        <tr style="cursor:pointer" onclick="openFullOrder('${id}')">
                            <td>#${id.slice(-4)}</td>
                            <td>${new Date(o.timestamp).toLocaleString('ar-EG', {hour:'2-digit', minute:'2-digit'})}</td>
                            <td>${o.customerName}</td>
                            <td><b>${o.total} Ø¬</b></td>
                            <td><span style="color:${o.status==='completed'?'green':(o.status==='cancelled'?'red':'orange')}">${o.status==='completed'?'Ù…ÙƒØªÙ…Ù„':(o.status==='cancelled'?'Ù…Ù„ØºÙŠ':'Ø¬Ø§Ø±ÙŠ')}</span></td>
                            <td>${o.handledBy || '-'}</td>
                        </tr>`;
                }
            });

            if(document.getElementById('todaySales')) {
                document.getElementById('todaySales').innerText = sales + " Ø¬";
                document.getElementById('todayCount').innerText = count;
                document.getElementById('canxCount').innerText = canx;
            }
        }

        window.generateReport = () => {
            const start = new Date(document.getElementById('repStart').value).setHours(0,0,0,0);
            const end = new Date(document.getElementById('repEnd').value).setHours(23,59,59,999);
            if (isNaN(start)) { alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹!"); return; }

            const repData = {}; let grandTotal = 0;
            Object.values(allOrdersData).forEach(o => {
                if (o.status === 'completed' && o.timestamp >= start && o.timestamp <= end) {
                    const emp = o.handledBy || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                    if (!repData[emp]) repData[emp] = { c: 0, t: 0 };
                    repData[emp].c++; repData[emp].t += parseInt(o.total);
                    grandTotal += parseInt(o.total);
                }
            });

            document.getElementById('reportBox').style.display = 'block';
            document.getElementById('reportTBody').innerHTML = Object.entries(repData).map(([n, d]) => `<tr><td>${n}</td><td>${d.c} Ø·Ù„Ø¨Ø§Øª</td><td>${d.t} Ø¬.Ù…</td></tr>`).join('');
            document.getElementById('grandTotal').innerText = grandTotal;
        };

        // --- 6. Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø³ØªÙŠÙƒØ±Ø§Øª ---
        function renderTeamChatBox(msgs) {
            const box = document.getElementById('teamChatBox'); box.innerHTML = '';
            Object.values(msgs).forEach(m => {
                const isMe = m.sender === currentUser.name;
                box.innerHTML += `
                    <div class="team-msg ${isMe?'mine':'others'}">
                        <small style="color:orange; font-weight:bold;">${m.sender}</small>
                        <div style="margin-top:4px;">${m.text}</div>
                        <small style="font-size:0.6rem; color:#999; display:block; margin-top:5px;">${new Date(m.timestamp).toLocaleTimeString('ar-EG')}</small>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        }

        window.sendTeamMsg = () => {
            const inp = document.getElementById('tMsgInp');
            if (inp.value.trim()) {
                DB.push('team_chat', { sender: currentUser.name, text: inp.value, timestamp: Date.now() });
                inp.value = '';
            }
        };

        window.toggleStickers = () => document.getElementById('stickersPanel').classList.toggle('open');
        window.sendSticker = (url) => {
            DB.push('team_chat', { sender: currentUser.name, text: `<img src="${url}" style="max-width:130px; border-radius:12px;">`, timestamp: Date.now() });
            toggleStickers();
        };

        // --- 7. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ---
        window.addVToTemp = () => {
            const l = document.getElementById('vLabel').value;
            const p = document.getElementById('vPrice').value;
            if (l && p) {
                tempVariantsBuffer.push({ bread: l, price: p });
                document.getElementById('tempVDisplay').innerHTML += ` <span style="background:#eee; padding:5px; border-radius:5px; margin-left:5px;">${l}: ${p}Ø¬</span> `;
                document.getElementById('vLabel').value = ''; document.getElementById('vPrice').value = '';
            }
        };

        window.finalSaveProduct = () => {
            const name = document.getElementById('pName').value;
            const img = document.getElementById('pImg').value;
            const cat = document.getElementById('pCatSelect').value;
            if (name && tempVariantsBuffer.length > 0) {
                DB.push('products', { name, img, cat, variants: tempVariantsBuffer, available: true });
                alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­!");
                tempVariantsBuffer = []; document.getElementById('tempVDisplay').innerHTML = '';
            } else alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙˆØ¥Ø¶Ø§ÙØ© Ø³Ø¹Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
        };

        function renderManageMenu(prods) {
            const body = document.getElementById('managePBody'); body.innerHTML = '';
            Object.entries(prods).forEach(([id, p]) => {
                body.innerHTML += `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.cat}</td>
                        <td style="color:${p.available?'green':'red'}; font-weight:bold;">${p.available?'Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†':'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</td>
                        <td>
                            <button onclick="togglePStatus('${id}', ${p.available})" style="background:#444; color:white; border:none; padding:8px; border-radius:5px; cursor:pointer">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©</button>
                            <button onclick="deleteP('${id}')" style="background:var(--red); color:white; border:none; padding:8px; border-radius:5px; cursor:pointer">Ø­Ø°Ù</button>
                        </td>
                    </tr>`;
            });
        }
        window.togglePStatus = (id, cur) => DB.update(`products/${id}`, { available: !cur });
        window.deleteP = (id) => { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) DB.remove(`products/${id}`); };

        window.addNewStaff = () => {
            const n = document.getElementById('uFullName').value;
            const p = document.getElementById('uPassInput').value;
            const r = document.getElementById('uRoleSelect').value;
            if (n && p) {
                DB.push('users', { name: n, pass: p, role: r });
                alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­.");
                document.getElementById('uFullName').value = ''; document.getElementById('uPassInput').value = '';
            }
        };
        function renderStaffTable() {
            const body = document.getElementById('staffTableBody'); body.innerHTML = '';
            Object.entries(allStaffData).forEach(([id, u]) => {
                body.innerHTML += `<tr><td>${u.name}</td><td>${u.role==='admin'?'Ù…Ø¯ÙŠØ±':'Ù…ÙˆØ¸Ù'}</td><td><button onclick="DB.remove('users/${id}')" style="color:red; background:none; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- 8. Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø·ÙˆØ± ---
        function renderCustChatSidebar(chats) {
            const list = document.getElementById('custChatList'); list.innerHTML = '';
            Object.entries(chats).forEach(([phone, msgs]) => {
                const last = Object.values(msgs).pop();
                list.innerHTML += `
                    <div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer; transition:0.2s;" onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='white'" onclick="loadCustomerConversation('${phone}')">
                        <b style="color:var(--blue)">${phone}</b><br>
                        <small style="color:#777">${last.text.substring(0,25)}...</small>
                    </div>`;
            });
        }

        window.loadCustomerConversation = (phone) => {
            activeChatPhone = phone;
            document.getElementById('custChatHeader').style.display = 'block';
            document.getElementById('activeCustName').innerText = phone;
            document.getElementById('custChatFooter').style.display = 'flex';
            
            DB.listen(`chats/${phone}`, msgs => {
                const box = document.getElementById('custChatBox'); box.innerHTML = '';
                Object.values(msgs).forEach(m => {
                    const isAdmin = m.sender === 'admin';
                    box.innerHTML += `
                        <div style="padding:12px; border-radius:15px; max-width:75%; align-self:${isAdmin?'flex-end':'flex-start'}; background:${isAdmin?'#dcf8c6':'white'}; box-shadow:0 1px 3px rgba(0,0,0,0.1); border:${isAdmin?'none':'1px solid #eee'}">
                            ${m.text}
                            <small style="display:block; font-size:0.6rem; color:#999; margin-top:5px; text-align:left;">${new Date(m.timestamp).toLocaleTimeString('ar-EG')}</small>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        window.sendReplyToCust = () => {
            const inp = document.getElementById('custReplyInp');
            if (inp.value.trim() && activeChatPhone) {
                DB.push(`chats/${activeChatPhone}`, { sender: 'admin', text: inp.value, timestamp: Date.now() });
                inp.value = '';
            }
        };

    </script>
</body>
</html>
