<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯ - Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
      const firebaseConfig = {
        apiKey: "AIzaSyCYrGDMzUuQ1MiHmCy2OPId8yG07DyRT_g",
        authDomain: "sheikh-of-the-country.firebaseapp.com",
        projectId: "sheikh-of-the-country",
        storageBucket: "sheikh-of-the-country.firebasestorage.app",
        messagingSenderId: "767891906712",
        appId: "1:767891906712:web:1ee97ae642db1eb77b70ed",
        measurementId: "G-PLL1LDBRM1"
      };

      // ØªÙ‡ÙŠØ¦Ø© Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ù„Ù€ window Ù„ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
      window.db = db;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbPush = push;
      window.dbOnValue = onValue;
      window.dbUpdate = update;
      window.dbRemove = remove;
      window.dbGet = get;

      console.log("Firebase Connected Successfully! âœ…");
      
      // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
      startSystem();
    </script>

    <style>
        /* ÙƒÙ„ Ø§Ù„Ù€ CSS Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø­Ø°Ù */
        :root {
            --primary-red: #721812;
            --primary-yellow: #ffe755;
            --white: #ffffff;
            --bg-main: #fffcf0;
            --blue: #18248b; --red: #8c0104; --green: #27ae60; --gray: #f0f2f5;
        }
        body { margin: 0; font-family: 'Cairo', sans-serif; display: flex; background: var(--gray); height: 100vh; overflow: hidden; }

        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #18248b 0%, #0c144d 100%);
            display: flex; justify-content: center; align-items: center; z-index: 3000;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); width: 100%; max-width: 400px; text-align: center;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .login-card h1 { color: #18248b; font-size: 1.8rem; margin-bottom: 30px; font-weight: 800; }

        .input-group { position: relative; margin-bottom: 20px; text-align: right; }
        .input-group i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #18248b; opacity: 0.6; }

        #loginScreen input {
            width: 100%; padding: 14px 45px 14px 15px; border: 2px solid #eee;
            border-radius: 10px; font-size: 1rem; transition: 0.3s; box-sizing: border-box; background: #f9f9f9;
        }

        #loginScreen input:focus { border-color: #8c0104; background: #fff; outline: none; box-shadow: 0 0 8px rgba(140, 1, 4, 0.1); }

        #loginScreen button {
            width: 100%; padding: 14px; background: #8c0104; color: white; border: none;
            border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(140, 1, 4, 0.3);
        }

        #loginScreen button:hover { background: #b71c1c; transform: translateY(-2px); }

        .sidebar { width: 260px; background: var(--primary-red); color: white; padding: 20px 10px; display: flex; flex-direction: column; border-left: 5px solid var(--primary-yellow); }
        .menu-item { padding: 12px; margin: 5px 0; cursor: pointer; border-radius: 5px; display: flex; align-items: center; gap: 10px; transition: 0.3s; position: relative; color: var(--primary-yellow); }
        .menu-item:hover, .menu-item.active { background: rgba(255,231,85,0.1); border-right: 4px solid var(--primary-yellow); }
        
        .badge-counter { background: var(--primary-yellow); color: var(--primary-red); border-radius: 50%; padding: 2px 6px; font-size: 0.75rem; position: absolute; left: 15px; display: none; font-weight: 900; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .main { flex: 1; padding: 25px; overflow-y: auto; background: var(--bg-main); }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .form-box { background: white; padding: 25px; border-radius: 10px; max-width: 900px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .users-table { width: 100%; border-collapse: collapse; background: white; margin-top: 0; }
        .users-table thead tr { background-color: var(--primary-red); color: var(--primary-yellow); }
        .users-table th, .users-table td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }

        .order-column { flex: 1; background: #ffffff; border-radius: 20px; padding: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.03); border: 1px solid #edf2f7; display: flex; flex-direction: column; height: 80vh; }
        .column-header { padding: 15px; border-radius: 15px; margin-bottom: 15px; font-weight: 800; display: flex; align-items: center; gap: 10px; font-size: 1.1rem; }
        .header-new { background: #fff5f5; color: #c53030; border-right: 5px solid #c53030; }
        .header-process { background: #ebf8ff; color: #2b6cb0; border-right: 5px solid #2b6cb0; }

        .order-card.modern { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: all 0.3s ease; cursor: pointer; position: relative; }
        .order-card.modern:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0,0,0,0.05); }
        .order-price-tag { font-size: 1.2rem; font-weight: 800; color: var(--primary-red); }

        /* Team Chat Styles */
        .team-chat-container { display: flex; flex-direction: column; height: 75vh; background: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); border-radius: 15px; overflow: hidden; position: relative; }
        .team-chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .team-msg { padding: 10px 15px; border-radius: 15px; max-width: 75%; position: relative; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .team-msg.mine { background: #dcf8c6; align-self: flex-end; }
        .team-msg.others { background: white; align-self: flex-start; }
        
        .stickers-panel { height: 0; background: white; transition: 0.3s; overflow: hidden; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .stickers-panel.open { height: 160px; padding: 10px; border-top: 1px solid #ccc; overflow-y: auto; }
        .sticker-item { cursor: pointer; text-align: center; height: 70px; display: flex; align-items: center; justify-content: center; background: #eee; border-radius: 5px; }
        .sticker-item img { max-width: 100%; max-height: 100%; }

        /* Dash Cards */
        .dash-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: white; padding: 20px; border-radius: 15px; border-bottom: 4px solid var(--primary-red); transition: 0.3s; text-align: center; }
        .stat-val { font-size: 2rem; font-weight: bold; color: var(--primary-red); }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 20px; width: 550px; max-width: 95%; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { background: var(--primary-red); color: var(--primary-yellow); padding: 20px; display: flex; justify-content: space-between; align-items: center; }

        /* Customer Chat Layout */
        .chat-layout { display: flex; height: 75vh; background: #fff; border-radius: 15px; overflow: hidden; border: 1px solid #d1d7db; }
        .chat-list { width: 300px; background: #fff; border-left: 1px solid #e0e0e0; display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: #efeae2; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); }
    </style>
</head>
<body>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" loop></audio>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen">
        <div class="login-card">
            <div style="width:90px; height:90px; margin: 0 auto 20px; border-radius:50%; overflow:hidden; border:3px solid #eee;">
                <img src="792c5d7f-7b45-4e3f-9333-c69926ecaa3f (1).jpg" alt="Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <h1>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</h1>
            <div class="input-group">
                <i class="fas fa-user"></i>
                <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <button id="loginBtn">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            <p style="margin-top: 20px; color: #777; font-size: 0.8rem;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø´Ø±ÙƒØ© Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯ &copy; 2026</p>
        </div>
    </div>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
    <div class="sidebar">
        <div style="text-align:center; margin-bottom:20px;">
            <img src="792c5d7f-7b45-4e3f-9333-c69926ecaa3f (1).jpg" style="width:70px; border-radius:50%; border:2px solid gold;">
            <h3 id="adminNameDisplay" style="margin-top:10px; color: gold;">-</h3>
        </div>
        <div class="menu-item active" onclick="nav('live-orders')"><i class="fas fa-bell"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ©</div>
        <div class="menu-item" onclick="nav('dashboard')"><i class="fas fa-chart-line"></i> Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
        <div class="menu-item" onclick="nav('team-chat-section')"><i class="fas fa-users"></i> Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚</div>
        
        <div class="admin-only">
            <div class="menu-item" onclick="nav('reports')"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
            <div class="menu-item" onclick="nav('products')"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</div>
            <div class="menu-item" onclick="nav('manage-products')"><i class="fas fa-boxes"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
            <div class="menu-item" onclick="nav('users')"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        </div>

        <div class="menu-item" id="chatMenuItem" onclick="nav('chat')">
            <i class="fas fa-comments"></i> Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ 
            <span class="badge-counter" id="chatNotifyBadge">0</span>
        </div>
        
        <div class="menu-item" onclick="logoutStaff()" style="margin-top:auto; background: #4d100c; border:1px solid gold;">
            <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="main">
        
        <!-- 1. Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© -->
        <div id="live-orders" class="section active">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3 style="margin:0;"><i class="fas fa-bolt" style="color: gold;"></i> Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
            </div>
            <div style="display: flex; gap: 20px; height: 75vh;">
                <div class="order-column">
                    <div class="column-header header-new"><i class="fas fa-star"></i> Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
                    <div id="newOrdersList" style="flex:1; overflow-y:auto;"></div>
                </div>
                <div class="order-column">
                    <div class="column-header header-process"><i class="fas fa-fire-alt"></i> ÙÙŠ Ø§Ù„Ù…Ø·Ø¨Ø®</div>
                    <div id="processingOrdersList" style="flex:1; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <!-- 2. Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div id="dashboard" class="section">
            <div class="dash-container" id="adminStatsBar">
                <div class="dash-card"><div>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div><div id="todaySales" class="stat-val">0 Ø¬</div></div>
                <div class="dash-card"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div><div id="totalCount" class="stat-val">0</div></div>
                <div class="dash-card"><div>Ø·Ù„Ø¨Ø§Øª Ù…Ù„ØºÙŠØ©</div><div id="cancelledCount" class="stat-val" style="color:red">0</div></div>
            </div>
            
            <div class="form-box" style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <div style="flex:2"><label>Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</label><input type="text" id="searchPhoneInput" onkeyup="filterHistory()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..."></div>
                <div style="flex:1"><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="filterStatus" onchange="filterHistory()"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="completed">Ù…ÙƒØªÙ…Ù„</option><option value="cancelled">Ù…Ù„ØºÙŠ</option></select></div>
                <button class="btn-blue" onclick="filterHistory()" style="height:45px">ÙÙ„ØªØ±Ø©</button>
            </div>

            <table class="users-table">
                <thead><tr><th>#</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…ÙˆØ¸Ù</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <!-- 3. Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <div id="reports" class="section">
            <div class="form-box">
                <h3>ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="reportStartDate"></div>
                    <div style="flex:1"><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="reportEndDate"></div>
                </div>
                <button class="btn-blue" onclick="generateReport()">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>
            <div id="reportResult" style="background:white; padding:20px; margin-top:20px; display:none; border-radius:10px;">
                <h3 style="text-align:center;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                <table class="users-table"><thead id="reportHead"></thead><tbody id="reportTableBody"></tbody></table>
                <h3 id="grandTotalRep" style="margin-top:20px; color: darkred;"></h3>
            </div>
        </div>

        <!-- 4. Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ -->
        <div id="team-chat-section" class="section">
            <div class="team-chat-container">
                <div class="team-chat-msgs" id="teamChatBox"></div>
                <div class="stickers-panel" id="stickersPanel">
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/m8WGPrQ3qVMAAAAM/cat-dance.gif')"><img src="https://media.tenor.com/m8WGPrQ3qVMAAAAM/cat-dance.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/NBX02q0mQf0AAAAM/laughing.gif')"><img src="https://media.tenor.com/NBX02q0mQf0AAAAM/laughing.gif"></div>
                </div>
                <div style="padding:15px; background:white; display:flex; gap:10px; align-items:center;">
                    <button onclick="toggleStickers()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">ğŸ˜Š</button>
                    <input type="text" id="teamMsgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙØ±ÙŠÙ‚..." style="margin:0;">
                    <button class="btn-blue" onclick="sendTeamMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>

        <!-- 5. Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ -->
        <div id="products" class="section">
            <div class="form-box">
                <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" id="prodName">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©</label><input type="text" id="prodImg">
                <label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><select id="prodCatSelect"></select>
                <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <h4>Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="vType" placeholder="Ø§Ù„ÙˆØµÙ (Ù…Ø«Ù„Ø§Ù‹: Ø®Ø¨Ø² ØµØ§Ø¬)" style="flex:2">
                        <input type="number" id="vPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="flex:1">
                        <button class="btn-blue" onclick="addVariantToTemp()">Ø£Ø¶Ù Ø§Ù„Ø³Ø¹Ø±</button>
                    </div>
                    <div id="tempVarsDisplay" style="margin-top:10px; font-weight:bold;"></div>
                </div>
                <button class="btn-blue" style="width:100%" onclick="saveProduct()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            </div>
        </div>

        <!-- 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
        <div id="manage-products" class="section">
            <h3>Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…Ù†ÙŠÙˆ (Ù…ØªØ§Ø­/ØºÙŠØ± Ù…ØªØ§Ø­)</h3>
            <table class="users-table">
                <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="manageProdList"></tbody>
            </table>
        </div>

        <!-- 7. Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="users" class="section">
            <div class="form-box">
                <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3>
                <input type="text" id="newUName" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <input type="password" id="newUPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <select id="newURole"><option value="receiver">ÙƒØ§Ø´ÙŠØ± / Ù…Ø·Ø¨Ø®</option><option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</option></select>
                <button class="btn-blue" onclick="addNewUser()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù</button>
            </div>
            <table class="users-table">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø­Ø°Ù</th></tr></thead>
                <tbody id="usersListBody"></tbody>
            </table>
        </div>

        <!-- 8. Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
        <div id="chat" class="section">
            <div class="chat-layout">
                <div class="chat-list" id="chatUsersList"></div>
                <div class="chat-area">
                    <div id="chatHeaderArea" style="padding:15px; background:white; font-weight:bold; border-bottom:1px solid #ddd; display:none;">Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø³Ù„Ø©: <span id="currentChatUser"></span></div>
                    <div id="adminChatBox" style="flex:1; overflow-y:auto; padding:20px;"></div>
                    <div id="chatInputArea" style="padding:15px; background:white; display:none; gap:10px;">
                        <input type="text" id="adminChatInput" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¹Ù…ÙŠÙ„..." style="margin:0;">
                        <button class="btn-blue" onclick="sendAdminMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„Ø§Øª -->
    <div class="modal" id="orderModal"></div>

    <script>
        // --- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ÙˆØ§Ù„Ø§ØªØµØ§Ù„ ---
        const DB = {
            push: (path, item) => window.dbPush(window.dbRef(window.db, path), item),
            update: (path, updates) => window.dbUpdate(window.dbRef(window.db, path), updates),
            remove: (path) => window.dbRemove(window.dbRef(window.db, path)),
            listen: (path, callback) => window.dbOnValue(window.dbRef(window.db, path), (snapshot) => callback(snapshot.val() || {}))
        };

        let currentUser = JSON.parse(localStorage.getItem('sheikh_staff_user'));
        let allOrders = {};
        let allUsersData = {};
        let tempVariants = [];
        let activeChatUser = null;

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        document.getElementById('loginBtn').onclick = function() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();

            // 1. Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            if (u === 'admin' && p === '123') {
                const adminData = { name: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', role: 'admin', key: 'static_admin' };
                loginSuccess(adminData);
                return;
            }

            // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Firebase
            let found = false;
            Object.entries(allUsersData).forEach(([key, user]) => {
                if (user.name === u && user.pass === p) {
                    const userData = { ...user, key: key };
                    loginSuccess(userData);
                    found = true;
                }
            });

            if (!found) alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
        };

        function loginSuccess(user) {
            currentUser = user;
            localStorage.setItem('sheikh_staff_user', JSON.stringify(user));
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminNameDisplay').innerText = user.name;
            
            if (user.role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                document.getElementById('adminStatsBar').style.display = 'none';
            }
        }

        function logoutStaff() { localStorage.removeItem('sheikh_staff_user'); location.reload(); }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ---
        function startSystem() {
            if (currentUser) loginSuccess(currentUser);

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª
            DB.listen('orders', (data) => {
                allOrders = data;
                renderOrders(data);
                filterHistory();
            });

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            DB.listen('users', (data) => {
                allUsersData = data;
                renderUsersList(data);
            });

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚
            DB.listen('team_chat', (data) => renderTeamChat(data));

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            DB.listen('chats', (data) => renderCustomerChatsList(data));

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª
            DB.listen('products', (data) => renderManageProducts(data));
            DB.listen('categories', (data) => renderCategoriesList(data));
        }

        // --- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© ---
        function renderOrders(data) {
            const newList = document.getElementById('newOrdersList');
            const procList = document.getElementById('processingOrdersList');
            newList.innerHTML = ''; procList.innerHTML = '';
            let newOrderFound = false;

            Object.entries(data).reverse().forEach(([id, order]) => {
                if (order.status === 'completed' || order.status === 'cancelled') return;

                const card = `
                    <div class="order-card modern" onclick="openOrderDetails('${id}')">
                        <div style="display:flex; justify-content:space-between">
                            <b>#${id.slice(-4)}</b>
                            <small>${new Date(order.timestamp).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'})}</small>
                        </div>
                        <h4 style="margin:10px 0">${order.customerName}</h4>
                        <div style="color:#666; font-size:0.85rem"><i class="fas fa-phone"></i> ${order.phone}</div>
                        <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                            <span class="order-price-tag">${order.total} Ø¬</span>
                            <span style="font-size:0.75rem; background:#eee; padding:3px 8px; border-radius:5px">ØªÙØ§ØµÙŠÙ„</span>
                        </div>
                    </div>`;

                if (order.status === 'pending' || order.status === 'new') {
                    newList.innerHTML += card;
                    if (!order.seenByAdmin) newOrderFound = true;
                } else if (order.status === 'processing') {
                    procList.innerHTML += card;
                }
            });

            if (newOrderFound) document.getElementById('alarmSound').play().catch(()=>{});
            else { document.getElementById('alarmSound').pause(); document.getElementById('alarmSound').currentTime = 0; }
        }

        window.openOrderDetails = function(id) {
            const o = allOrders[id];
            DB.update('orders/'+id, {seenByAdmin: true});
            
            const modal = document.getElementById('orderModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header"><span>Ø·Ù„Ø¨ Ø±Ù‚Ù… #${id.slice(-4)}</span><i class="fas fa-utensils"></i></div>
                    <div style="padding:20px;">
                        <div style="background:#fffdf2; padding:15px; border-radius:10px; border-right:5px solid darkred; margin-bottom:15px;">
                            <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${o.customerName} <br>
                            <b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${o.phone} <br>
                            <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${o.address}
                        </div>
                        <table style="width:100%; border-collapse:collapse;">
                            ${o.items.map(item => `<tr style="border-bottom:1px dashed #ddd"><td style="padding:10px"><b>${item.count}x</b> ${item.name}</td><td style="text-align:left">${item.price} Ø¬</td></tr>`).join('')}
                        </table>
                        <h2 style="text-align:center; color:darkred; margin:20px 0;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total} Ø¬.Ù…</h2>
                        <div style="display:flex; gap:10px;">
                            ${(o.status === 'pending' || o.status === 'new') ? 
                                `<button class="btn-blue" style="background:green; flex:2" onclick="changeOrderStatus('${id}','processing')">Ù‚Ø¨ÙˆÙ„ ÙˆØªØ¬Ù‡ÙŠØ²</button>
                                 <button class="btn-blue" style="background:red; flex:1" onclick="cancelOrder('${id}')">Ø±ÙØ¶</button>` :
                                `<button class="btn-blue" style="background:darkred; width:100%" onclick="changeOrderStatus('${id}','completed')">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</button>`
                            }
                        </div>
                    </div>
                    <button onclick="closeModal()" style="width:100%; padding:15px; border:none; background:#eee; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>`;
            modal.style.display = 'flex';
        }

        window.changeOrderStatus = function(id, status) {
            DB.update('orders/'+id, {status: status, handledBy: currentUser.name});
            closeModal();
        }

        window.cancelOrder = function(id) {
            const reason = prompt("Ù…Ø§ Ù‡Ùˆ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ØŸ");
            if (reason) {
                DB.update('orders/'+id, {status: 'cancelled', adminReason: reason, handledBy: currentUser.name});
                closeModal();
            }
        }

        window.closeModal = function() { document.getElementById('orderModal').style.display = 'none'; }

        // --- Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ---
        function filterHistory() {
            const term = document.getElementById('searchPhoneInput').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            const body = document.getElementById('historyTableBody');
            body.innerHTML = '';

            let todayTotal = 0, totalOrders = 0, cancelled = 0;

            Object.entries(allOrders).reverse().forEach(([id, o]) => {
                if ( (o.phone.includes(term) || o.customerName.toLowerCase().includes(term)) && (status === 'all' || o.status === status) ) {
                    
                    if (o.status === 'completed') { todayTotal += parseInt(o.total); totalOrders++; }
                    if (o.status === 'cancelled') cancelled++;

                    body.innerHTML += `
                        <tr>
                            <td>#${id.slice(-4)}</td>
                            <td>${o.customerName}</td>
                            <td>${o.phone}</td>
                            <td><b>${o.total} Ø¬</b></td>
                            <td><span style="color:${o.status==='completed'?'green':(o.status==='cancelled'?'red':'orange')}">${o.status==='completed'?'Ù…ÙƒØªÙ…Ù„':(o.status==='cancelled'?'Ù…Ù„ØºÙŠ':'Ø¬Ø§Ø±ÙŠ')}</span></td>
                            <td>${o.handledBy || '-'}</td>
                        </tr>`;
                }
            });

            document.getElementById('todaySales').innerText = todayTotal + " Ø¬";
            document.getElementById('totalCount').innerText = totalOrders;
            document.getElementById('cancelledCount').innerText = cancelled;
        }

        // --- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ---
        function generateReport() {
            const start = new Date(document.getElementById('reportStartDate').value).setHours(0,0,0,0);
            const end = new Date(document.getElementById('reportEndDate').value).setHours(23,59,59,999);
            
            if (isNaN(start) || isNaN(end)) { alert("Ø§Ø®ØªØ± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹!"); return; }

            const reportData = {};
            let grandTotal = 0;

            Object.values(allOrders).forEach(o => {
                if (o.status === 'completed' && o.timestamp >= start && o.timestamp <= end) {
                    const emp = o.handledBy || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                    if (!reportData[emp]) reportData[emp] = {count: 0, total: 0};
                    reportData[emp].count++;
                    reportData[emp].total += parseInt(o.total);
                    grandTotal += parseInt(o.total);
                }
            });

            document.getElementById('reportResult').style.display = 'block';
            document.getElementById('reportHead').innerHTML = `<tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th></tr>`;
            document.getElementById('reportTableBody').innerHTML = Object.entries(reportData).map(([name, data]) => `<tr><td>${name}</td><td>${data.count}</td><td>${data.total} Ø¬</td></tr>`).join('') || "<tr><td colspan='3'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>";
            document.getElementById('grandTotalRep').innerText = "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: " + grandTotal + " Ø¬.Ù…";
        }

        // --- Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ ---
        function renderTeamChat(msgs) {
            const box = document.getElementById('teamChatBox');
            box.innerHTML = '';
            Object.values(msgs).forEach(m => {
                const isMe = m.sender === currentUser.name;
                box.innerHTML += `
                    <div class="team-msg ${isMe?'mine':'others'}">
                        <small style="color:orange">${m.sender}</small>
                        <div>${m.text}</div>
                        <small style="font-size:0.6rem; color:#999">${new Date(m.timestamp).toLocaleTimeString('ar-EG')}</small>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        }

        window.sendTeamMsg = function() {
            const inp = document.getElementById('teamMsgInput');
            if (inp.value.trim()) {
                DB.push('team_chat', {sender: currentUser.name, text: inp.value, timestamp: Date.now()});
                inp.value = '';
            }
        }

        window.toggleStickers = function() { document.getElementById('stickersPanel').classList.toggle('open'); }
        window.sendSticker = function(url) {
            DB.push('team_chat', {sender: currentUser.name, text: `<img src="${url}" style="max-width:120px; border-radius:10px">`, timestamp: Date.now()});
            toggleStickers();
        }

        // --- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
        function addVariantToTemp() {
            const type = document.getElementById('vType').value;
            const price = document.getElementById('vPrice').value;
            if (type && price) {
                tempVariants.push({bread: type, price: price});
                document.getElementById('tempVarsDisplay').innerHTML += ` [${type}: ${price}Ø¬] `;
                document.getElementById('vType').value = ''; document.getElementById('vPrice').value = '';
            }
        }

        function saveProduct() {
            const name = document.getElementById('prodName').value;
            const img = document.getElementById('prodImg').value;
            const cat = document.getElementById('prodCatSelect').value;
            if (name && tempVariants.length > 0) {
                DB.push('products', {name, img, cat, variants: tempVariants, available: true});
                alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!");
                tempVariants = []; document.getElementById('tempVarsDisplay').innerText = '';
            } else alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ø¶Ù Ø³Ø¹Ø±Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
        }

        function renderManageProducts(products) {
            const list = document.getElementById('manageProdList');
            list.innerHTML = '';
            Object.entries(products).forEach(([id, p]) => {
                list.innerHTML += `
                    <tr>
                        <td>${p.name}</td>
                        <td>${p.cat}</td>
                        <td style="color:${p.available?'green':'red'}">${p.available?'Ù…ØªØ§Ø­':'ØºÙŠØ± Ù…ØªØ§Ø­'}</td>
                        <td>
                            <button class="btn-blue" style="background:#444" onclick="toggleProduct('${id}', ${p.available})">ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©</button>
                            <button class="btn-blue" style="background:darkred" onclick="deleteProduct('${id}')">Ø­Ø°Ù</button>
                        </td>
                    </tr>`;
            });
        }

        window.toggleProduct = (id, cur) => DB.update('products/'+id, {available: !cur});
        window.deleteProduct = (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) DB.remove('products/'+id); }

        // --- Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ---
        function renderCategoriesList(cats) {
            const select = document.getElementById('prodCatSelect');
            select.innerHTML = Object.values(cats).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        function addNewUser() {
            const name = document.getElementById('newUName').value;
            const pass = document.getElementById('newUPass').value;
            const role = document.getElementById('newURole').value;
            if (name && pass) {
                DB.push('users', {name, pass, role});
                alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù");
            }
        }

        function renderUsersList(users) {
            const list = document.getElementById('usersListBody');
            list.innerHTML = Object.entries(users).map(([id, u]) => `<tr><td>${u.name}</td><td>${u.role}</td><td><button onclick="deleteUser('${id}')">Ø­Ø°Ù</button></td></tr>`).join('');
        }
        window.deleteUser = (id) => DB.remove('users/'+id);

        // --- Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ---
        function renderCustomerChatsList(chats) {
            const list = document.getElementById('chatUsersList');
            list.innerHTML = '';
            Object.entries(chats).forEach(([phone, msgs]) => {
                const msgsArr = Object.values(msgs);
                const last = msgsArr[msgsArr.length - 1];
                list.innerHTML += `<div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer" onclick="loadCustomerChat('${phone}')"><b>${phone}</b><br><small>${last.text.substring(0,20)}...</small></div>`;
            });
        }

        window.loadCustomerChat = function(phone) {
            activeChatUser = phone;
            document.getElementById('chatHeaderArea').style.display = 'block';
            document.getElementById('currentChatUser').innerText = phone;
            document.getElementById('chatInputArea').style.display = 'flex';
            
            DB.listen('chats/'+phone, (msgs) => {
                const box = document.getElementById('adminChatBox');
                box.innerHTML = Object.values(msgs).map(m => `<div style="padding:10px; margin:5px; border-radius:10px; align-self:${m.sender==='admin'?'flex-end':'flex-start'}; background:${m.sender==='admin'?'#dcf8c6':'white'}; max-width:70%;">${m.text}</div>`).join('');
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendAdminMsg = function() {
            const inp = document.getElementById('adminChatInput');
            if (inp.value && activeChatUser) {
                DB.push('chats/'+activeChatUser, {sender: 'admin', text: inp.value, timestamp: Date.now()});
                inp.value = '';
            }
        }
    </script>
</body>
</html>
