<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Ù…ÙƒØªØ¨Ø§Øª Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getDatabase, ref, set, push, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCYrGDMzUuQ1MiHmCy2OPId8yG07DyRT_g",
        authDomain: "sheikh-of-the-country.firebaseapp.com",
        projectId: "sheikh-of-the-country",
        storageBucket: "sheikh-of-the-country.firebasestorage.app",
        messagingSenderId: "767891906712",
        appId: "1:767891906712:web:1ee97ae642db1eb77b70ed",
        measurementId: "G-PLL1LDBRM1"
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      window.db = db;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbPush = push;
      window.dbOnValue = onValue;
      window.dbUpdate = update;
      window.dbRemove = remove;
      window.dbGet = get;

      console.log("Firebase Connected Successfully! âœ…");
      startSystem();
    </script>

    <style>
        /* --- ÙƒÙ„ Ø§Ù„Ù€ CSS Ø§Ù„Ø£ØµÙ„ÙŠ Ø¨ØªØ§Ø¹Ùƒ Ø¨ØªÙØ§ØµÙŠÙ„Ù‡ --- */
        :root {
            --primary-red: #721812; --primary-yellow: #ffe755;
            --white: #ffffff; --bg-main: #fffcf0;
            --blue: #18248b; --red: #8c0104; --green: #27ae60; --gray: #f0f2f5;
        }

        body { margin: 0; font-family: 'Cairo', sans-serif; display: flex; background: var(--gray); height: 100vh; overflow: hidden; }

        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #18248b 0%, #0c144d 100%);
            display: flex; justify-content: center; align-items: center; z-index: 5000;
        }

        .login-card {
            background: white; padding: 40px; border-radius: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); width: 100%; max-width: 400px; text-align: center;
        }

        .sidebar { width: 280px; background: var(--primary-red); color: white; padding: 25px 15px; display: flex; flex-direction: column; border-left: 5px solid var(--primary-yellow); z-index: 100; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
        .sidebar h2 { text-align: center; color: var(--primary-yellow); font-weight: 900; margin-bottom: 30px; font-size: 1.5rem; }
        
        .menu-item { padding: 15px; margin: 8px 0; cursor: pointer; border-radius: 12px; display: flex; align-items: center; gap: 15px; transition: 0.3s; color: var(--primary-yellow); font-weight: 700; position: relative; }
        .menu-item:hover, .menu-item.active { background: rgba(255, 231, 85, 0.15); border-right: 5px solid var(--primary-yellow); }
        .badge-counter { background: var(--primary-yellow); color: var(--primary-red); border-radius: 50%; padding: 4px 10px; font-size: 0.8rem; position: absolute; left: 15px; font-weight: 900; animation: pulse 1s infinite; }

        .main { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg-main); position: relative; }
        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dash-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 35px; }
        .dash-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-bottom: 6px solid var(--primary-red); text-align: center; transition: 0.3s; }
        .dash-card:hover { transform: translateY(-5px); }
        .stat-val { font-size: 2.2rem; font-weight: 900; color: var(--primary-red); margin-top: 10px; }

        .order-column { flex: 1; background: white; border-radius: 25px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); height: 80vh; display: flex; flex-direction: column; }
        .column-header { padding: 18px; border-radius: 15px; margin-bottom: 20px; font-weight: 900; font-size: 1.2rem; text-align: center; color: white; }
        .header-new { background: var(--red); border-right: 8px solid var(--primary-yellow); }
        .header-process { background: var(--blue); border-right: 8px solid var(--primary-yellow); }

        .order-card.modern { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #eee; box-shadow: 0 5px 15px rgba(0,0,0,0.02); cursor: pointer; transition: 0.3s; }
        .order-card.modern:hover { transform: scale(1.02); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .order-price-tag { font-size: 1.4rem; font-weight: 900; color: var(--primary-red); }

        .team-chat-container { display: flex; flex-direction: column; height: 75vh; background: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .team-chat-msgs { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .team-msg { padding: 12px 18px; border-radius: 18px; max-width: 75%; font-size: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); line-height: 1.5; }
        .team-msg.mine { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 2px; }
        .team-msg.others { background: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .stickers-panel { height: 0; background: white; transition: 0.4s; overflow: hidden; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .stickers-panel.open { height: 180px; padding: 15px; border-top: 2px solid #ddd; overflow-y: auto; }
        .sticker-item { cursor: pointer; background: #f7f7f7; border-radius: 12px; height: 80px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .sticker-item:hover { background: #eee; transform: scale(1.1); }

        .users-table { width: 100%; border-radius: 20px; overflow: hidden; border-collapse: collapse; background: white; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .users-table thead tr { background: var(--primary-red); color: var(--primary-yellow); }
        .users-table th, .users-table td { padding: 20px; text-align: center; border-bottom: 1px solid #f0f0f0; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 6000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; border-radius: 30px; width: 550px; max-width: 95%; box-shadow: 0 30px 60px rgba(0,0,0,0.4); overflow: hidden; animation: popUp 0.3s ease; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-header { background: var(--primary-red); color: var(--primary-yellow); padding: 25px; font-weight: 900; text-align: center; font-size: 1.4rem; }
    </style>
</head>
<body><audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" loop></audio>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen">
        <div class="login-card">
            <img src="792c5d7f-7b45-4e3f-9333-c69926ecaa3f (1).jpg" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--blue); margin-bottom:20px; object-fit:cover;">
            <h1>Ø¨ÙˆØ§Ø¨Ø© Ù…ÙˆØ¸ÙÙŠ Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</h1>
            <div class="input-group">
                <i class="fas fa-user-tie"></i>
                <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            </div>
            <div class="input-group">
                <i class="fas fa-key"></i>
                <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            <button id="loginBtn">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            <p style="margin-top:25px; color:#888; font-size:0.9rem;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© &copy; 2026</p>
        </div>
    </div>

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
    <div class="sidebar">
        <h2 id="adminNameDisplay">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
        <div class="menu-item active" onclick="nav('live-orders')"><i class="fas fa-bolt"></i> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© <span class="badge-counter" id="orderBadge" style="display:none">0</span></div>
        <div class="menu-item" onclick="nav('dashboard')"><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
        <div class="menu-item" onclick="nav('team-chat-section')"><i class="fas fa-comments"></i> Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚</div>
        
        <div class="admin-only">
            <div class="menu-item" onclick="nav('reports')"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
            <div class="menu-item" onclick="nav('products')"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</div>
            <div class="menu-item" onclick="nav('manage-products')"><i class="fas fa-boxes"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ</div>
            <div class="menu-item" onclick="nav('users')"><i class="fas fa-users-cog"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
        </div>

        <div class="menu-item" onclick="nav('customer-chat')"><i class="fas fa-headset"></i> Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="menu-item" onclick="logoutStaff()" style="margin-top:auto; background:rgba(0,0,0,0.3);"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="main">
        
        <!-- 1. Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­ÙŠØ© -->
        <div id="live-orders" class="section active">
            <div style="display:flex; gap:25px; height:80vh;">
                <div class="order-column">
                    <div class="column-header header-new">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
                    <div id="newOrdersList"></div>
                </div>
                <div class="order-column">
                    <div class="column-header header-process">ÙÙŠ Ø§Ù„Ù…Ø·Ø¨Ø® (Ø¬Ø§Ø±ÙŠ)</div>
                    <div id="processingOrdersList"></div>
                </div>
            </div>
        </div>

        <!-- 2. Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        <div id="dashboard" class="section">
            <div class="dash-container">
                <div class="dash-card"><div>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div><div id="todaySales" class="stat-val">0 Ø¬</div></div>
                <div class="dash-card"><div>Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</div><div id="todayCount" class="stat-val">0</div></div>
                <div class="dash-card"><div>Ù…Ø±ÙÙˆØ¶ / Ù…Ù„ØºÙŠ</div><div id="canxCount" class="stat-val" style="color:var(--red)">0</div></div>
            </div>
            <div style="background:white; padding:20px; border-radius:15px; margin-bottom:20px; display:flex; gap:15px;">
                <input type="text" id="histSearch" onkeyup="filterHistory()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." style="margin:0; flex:1">
                <select id="histStatus" onchange="filterHistory()" style="margin:0; width:200px;"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="completed">Ù…ÙƒØªÙ…Ù„</option><option value="cancelled">Ù…Ù„ØºÙŠ</option></select>
            </div>
            <table class="users-table">
                <thead><tr><th>#</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¨ÙˆØ§Ø³Ø·Ø©</th></tr></thead>
                <tbody id="historyTBody"></tbody>
            </table>
        </div>

        <!-- 3. Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
        <div id="reports" class="section">
            <div class="form-box">
                <h3>ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                <div style="display:flex; gap:15px;">
                    <div style="flex:1"><label>Ù…Ù†:</label><input type="date" id="repStart"></div>
                    <div style="flex:1"><label>Ø¥Ù„Ù‰:</label><input type="date" id="repEnd"></div>
                </div>
                <button class="btn-blue" onclick="generateReport()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
            <div id="repRes" style="display:none; background:white; padding:30px; border-radius:20px; margin-top:20px;">
                <h2 style="text-align:center;">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø§Ù„ÙŠ</h2>
                <table class="users-table"><tbody id="repTBody"></tbody></table>
                <h3 id="grandTotalText" style="margin-top:25px; color:darkred;"></h3>
            </div>
        </div>

        <!-- 4. Ø´Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ø§Ù„Ø³ØªÙŠÙƒØ±Ø§Øª -->
        <div id="team-chat-section" class="section">
            <div class="team-chat-container">
                <div class="team-chat-msgs" id="teamChatBox"></div>
                <div class="stickers-panel" id="stickersPanel">
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/m8WGPrQ3qVMAAAAM/cat-dance.gif')"><img src="https://media.tenor.com/m8WGPrQ3qVMAAAAM/cat-dance.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/NBX02q0mQf0AAAAM/laughing.gif')"><img src="https://media.tenor.com/NBX02q0mQf0AAAAM/laughing.gif"></div>
                    <div class="sticker-item" onclick="sendSticker('https://media.tenor.com/7Y6o7Y6oAAAAM/thumbs-up.gif')"><img src="https://media.tenor.com/7Y6o7Y6oAAAAM/thumbs-up.gif"></div>
                </div>
                <div style="padding:15px; background:white; display:flex; gap:12px; align-items:center;">
                    <button onclick="toggleStickers()" style="background:none; border:none; font-size:1.8rem; cursor:pointer">ğŸ˜Š</button>
                    <input type="text" id="tMsgInp" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„ÙØ±ÙŠÙ‚..." style="margin:0; flex:1">
                    <button class="btn-blue" onclick="sendTeamMsg()">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>

        <!-- 5. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
        <div id="products" class="section">
            <div class="form-box">
                <h3>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h3>
                <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                <input type="text" id="pImg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©">
                <select id="pCatInp"></select>
                <div style="background:#f9f9f9; padding:20px; border-radius:15px; margin-bottom:20px;">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="vLabel" placeholder="Ø§Ù„ÙˆØµÙ (Ø®Ø¨Ø² ØµØ§Ø¬)">
                        <input type="number" id="vPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        <button class="btn-blue" onclick="addV()">Ø£Ø¶Ù</button>
                    </div>
                    <div id="vDisplay" style="margin-top:15px; font-weight:bold; color:darkred;"></div>
                </div>
                <button class="btn-blue" style="width:100%" onclick="saveProd()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ù†ÙŠÙˆ</button>
            </div>
        </div>

        <!-- 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ÙŠÙˆ -->
        <div id="manage-products" class="section">
            <h3>Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªÙˆÙØ± Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
            <table class="users-table"><thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="pBody"></tbody></table>
        </div>

        <!-- 7. Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="users" class="section">
            <div class="form-box">
                <h3>ØªØ³Ø¬ÙŠÙ„ Ù…ÙˆØ¸Ù</h3>
                <input type="text" id="uName" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <input type="password" id="uPass" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯">
                <select id="uRole"><option value="admin">Ù…Ø¯ÙŠØ±</option><option value="receiver">Ù…Ø·Ø¨Ø® / ÙƒØ§Ø´ÙŠØ±</option></select>
                <button class="btn-blue" onclick="addUser()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <table class="users-table"><tbody id="uList"></tbody></table>
        </div>

        <!-- 8. Ø´Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
        <div id="customer-chat" class="section">
            <div class="chat-layout">
                <div class="chat-list" id="custList"></div>
                <div class="chat-area">
                    <div id="chatBox" style="flex:1; overflow-y:auto; padding:25px; display:flex; flex-direction:column; gap:10px;"></div>
                    <div id="chatFooter" style="padding:20px; background:white; display:none; gap:15px;">
                        <input type="text" id="cInp" placeholder="Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„..." style="margin:0; flex:1">
                        <button class="btn-blue" onclick="sendChat()">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="orderModal"></div>

    <script>
        const DB = {
            push: (path, item) => window.dbPush(window.dbRef(window.db, path), item),
            update: (path, updates) => window.dbUpdate(window.dbRef(window.db, path), updates),
            remove: (path) => window.dbRemove(window.dbRef(window.db, path)),
            listen: (path, callback) => window.dbOnValue(window.dbRef(window.db, path), (snap) => callback(snap.val() || {}))
        };

        let currentUser = JSON.parse(localStorage.getItem('sheikh_staff_user'));
        let allOrders = {}; let allUsers = {}; let tempVs = []; let activeCUser = null;

        document.getElementById('loginBtn').onclick = function() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(u === 'admin' && p === '123') { loginSuccess({name:'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…', role:'admin'}); return; }
            let f = false;
            Object.values(allUsers).forEach(user => { if(user.name === u && user.pass === p) { loginSuccess(user); f = true; } });
            if(!f) alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
        };

        function loginSuccess(user) {
            currentUser = user; localStorage.setItem('sheikh_staff_user', JSON.stringify(user));
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminNameDisplay').innerText = user.name;
            if(user.role !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.style.display='none');
        }

        function logoutStaff() { localStorage.removeItem('sheikh_staff_user'); location.reload(); }

        function nav(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function startSystem() {
            if(currentUser) loginSuccess(currentUser);
            DB.listen('users', data => { allUsers = data; renderU(); });
            DB.listen('orders', data => { allOrders = data; renderO(); filterHistory(); });
            DB.listen('team_chat', data => renderT(data));
            DB.listen('chats', data => renderCL(data));
            DB.listen('products', data => renderP(data));
            DB.listen('categories', data => {
                const sel = document.getElementById('pCatInp');
                sel.innerHTML = Object.values(data).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            });
        }

        function renderO() {
            const nL = document.getElementById('newOrdersList'); const pL = document.getElementById('processingOrdersList');
            nL.innerHTML = ''; pL.innerHTML = ''; let alarm = false;
            Object.entries(allOrders).reverse().forEach(([id, o]) => {
                if(o.status === 'completed' || o.status === 'cancelled') return;
                const card = `<div class="order-card modern" onclick="openO('${id}')"><b>#${id.slice(-4)}</b> - ${o.customerName}<br><span class="order-price-tag">${o.total} Ø¬</span></div>`;
                if(o.status === 'pending' || o.status === 'new') { nL.innerHTML += card; if(!o.seenByAdmin) alarm = true; }
                else if(o.status === 'processing') pL.innerHTML += card;
            });
            const sfx = document.getElementById('alarmSound');
            if(alarm) sfx.play().catch(()=>{}); else { sfx.pause(); sfx.currentTime = 0; }
        }

        window.openO = (id) => {
            const o = allOrders[id]; DB.update(`orders/${id}`, {seenByAdmin: true});
            const m = document.getElementById('orderModal');
            m.innerHTML = `<div class="modal-content"><div class="modal-header">Ø·Ù„Ø¨ #${id.slice(-4)}</div><div style="padding:25px;">
                <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${o.customerName}<br><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${o.phone}<br><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${o.address}<hr>
                ${o.items.map(i => `<div>${i.count}x ${i.name} (${i.price}Ø¬)</div>`).join('')}
                <h2 style="text-align:center; color:darkred;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total} Ø¬</h2>
                <div style="display:flex; gap:10px;">
                    ${(o.status==='pending'||o.status==='new')?`<button class="btn-blue" style="background:green;flex:1" onclick="upS('${id}','processing')">Ù‚Ø¨ÙˆÙ„</button><button class="btn-blue" style="background:red;flex:1" onclick="canxO('${id}')">Ø±ÙØ¶</button>`:
                    `<button class="btn-blue" style="background:darkred;width:100%" onclick="upS('${id}','completed')">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</button>`}
                </div></div><button onclick="closeM()" style="width:100%;padding:15px;border:none;background:#eee;cursor:pointer">Ø¥ØºÙ„Ø§Ù‚</button></div>`;
            m.style.display = 'flex';
        };

        window.upS = (id, s) => { DB.update(`orders/${id}`, {status:s, handledBy:currentUser.name}); closeM(); }
        window.canxO = (id) => { const r = prompt("Ø§Ù„Ø³Ø¨Ø¨:"); if(r) { DB.update(`orders/${id}`, {status:'cancelled', adminReason:r, handledBy:currentUser.name}); closeM(); } }
        window.closeM = () => document.getElementById('orderModal').style.display='none';

        function filterHistory() {
            const t = document.getElementById('histSearch').value.toLowerCase();
            const s = document.getElementById('histStatus').value;
            const b = document.getElementById('historyTBody'); b.innerHTML = '';
            let sales = 0, count = 0, canx = 0;
            Object.entries(allOrders).reverse().forEach(([id, o]) => {
                if((o.phone.includes(t) || o.customerName.toLowerCase().includes(t)) && (s === 'all' || o.status === s)) {
                    if(o.status === 'completed') { sales += parseInt(o.total); count++; }
                    if(o.status === 'cancelled') canx++;
                    b.innerHTML += `<tr><td>#${id.slice(-4)}</td><td>${new Date(o.timestamp).toLocaleDateString()}</td><td>${o.customerName}</td><td>${o.total} Ø¬</td><td>${o.status}</td><td>${o.handledBy||'-'}</td></tr>`;
                }
            });
            document.getElementById('todaySales').innerText = sales + " Ø¬";
            document.getElementById('todayCount').innerText = count;
            document.getElementById('canxCount').innerText = canx;
        }

        function generateReport() {
            const s = new Date(document.getElementById('repStart').value).setHours(0,0,0,0);
            const e = new Date(document.getElementById('repEnd').value).setHours(23,59,59,999);
            const rep = {}; let grand = 0;
            Object.values(allOrders).forEach(o => {
                if(o.status === 'completed' && o.timestamp >= s && o.timestamp <= e) {
                    const n = o.handledBy || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"; if(!rep[n]) rep[n] = {c:0, t:0};
                    rep[n].c++; rep[n].t += parseInt(o.total); grand += parseInt(o.total);
                }
            });
            document.getElementById('repRes').style.display = 'block';
            document.getElementById('repTBody').innerHTML = Object.entries(rep).map(([n,d])=>`<tr><td>${n}</td><td>${d.c} Ø·Ù„Ø¨Ø§Øª</td><td>${d.t} Ø¬</td></tr>`).join('');
            document.getElementById('grandTotalText').innerText = "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + grand + " Ø¬";
        }

        function renderT(msgs) {
            const b = document.getElementById('teamChatBox'); b.innerHTML = '';
            Object.values(msgs).forEach(m => {
                const isMe = m.sender === currentUser.name;
                b.innerHTML += `<div class="team-msg ${isMe?'mine':'others'}"><small style="color:orange">${m.sender}</small><div>${m.text}</div></div>`;
            });
            b.scrollTop = b.scrollHeight;
        }
        window.sendTeamMsg = () => { const i = document.getElementById('tMsgInp'); if(i.value) { DB.push('team_chat', {sender:currentUser.name, text:i.value, timestamp:Date.now()}); i.value=''; } }
        window.toggleStickers = () => document.getElementById('stickersPanel').classList.toggle('open');
        window.sendSticker = (url) => { DB.push('team_chat', {sender:currentUser.name, text:`<img src="${url}" style="max-width:120px; border-radius:10px;">`, timestamp:Date.now()}); toggleStickers(); }

        function renderCL(chats) {
            const l = document.getElementById('custList');
            l.innerHTML = Object.entries(chats).map(([p, m]) => `<div style="padding:15px; border-bottom:1px solid #eee; cursor:pointer" onclick="loadC('${p}')"><b>${p}</b></div>`).join('');
        }
        window.loadC = (p) => {
            activeCUser = p; document.getElementById('chatBox').innerHTML = ''; document.getElementById('chatFooter').style.display = 'flex';
            DB.listen(`chats/${p}`, msgs => {
                const b = document.getElementById('chatBox');
                b.innerHTML = Object.values(msgs).map(m => `<div style="padding:10px; margin:5px; border-radius:10px; align-self:${m.sender==='admin'?'flex-end':'flex-start'}; background:${m.sender==='admin'?'#dcf8c6':'white'}; max-width:70%;">${m.text}</div>`).join('');
                b.scrollTop = b.scrollHeight;
            });
        };
        window.sendChat = () => { const i = document.getElementById('cInp'); if(i.value && activeCUser) { DB.push(`chats/${activeCUser}`, {sender:'admin', text:i.value, timestamp:Date.now()}); i.value=''; } }

        window.addV = () => { const l = document.getElementById('vLabel').value, p = document.getElementById('vPrice').value; if(l&&p){ tempVs.push({bread:l, price:p}); document.getElementById('vDisplay').innerHTML += ` [${l}:${p}Ø¬] `; } }
        window.saveProd = () => {
            const n = document.getElementById('pName').value, i = document.getElementById('pImg').value, c = document.getElementById('pCatInp').value;
            if(n && tempVs.length>0) { DB.push('products', {name:n, img:i, cat:c, variants:tempVs, available:true}); alert("ØªÙ…!"); tempVs=[]; document.getElementById('vDisplay').innerText=''; }
        }
        function renderP(prods) {
            document.getElementById('pBody').innerHTML = Object.entries(prods).map(([id, p]) => `<tr><td>${p.name}</td><td>${p.available?'Ù…ØªØ§Ø­':'Ù…ØºÙ„Ù‚'}</td><td><button onclick="DB.update('products/${id}', {available:!${p.available}})">ØªØ¨Ø¯ÙŠÙ„</button> <button onclick="DB.remove('products/${id}')">Ø­Ø°Ù</button></td></tr>`).join('');
        }
        window.addUser = () => { const n = document.getElementById('uName').value, p = document.getElementById('uPass').value, r = document.getElementById('uRole').value; if(n&&p) DB.push('users', {name:n, pass:p, role:r}); }
        function renderU() { document.getElementById('uList').innerHTML = Object.entries(allUsers).map(([id, u]) => `<tr><td>${u.name}</td><td>${u.role}</td><td><button onclick="DB.remove('users/${id}')">Ø­Ø°Ù</button></td></tr>`).join(''); }
    </script>
</body>
</html>
    <!-- (Ù‡Ù†Ø§ Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ù€ HTML ÙÙŠ Ø§Ù„ØªÙƒÙ…Ù„Ø©) -->
