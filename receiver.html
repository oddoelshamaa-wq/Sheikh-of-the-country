<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شاشة استلام الطلبات - شيخ البلد</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- استدعاء مكتبات Firebase بطريقة CDN (مناسبة لـ GitHub Pages) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

      // إعدادات مشروعك الجديدة التي أرفقتها
      const firebaseConfig = {
        apiKey: "AIzaSyCYrGDMzUuQ1MiHmCy2OPId8yG07DyRT_g",
        authDomain: "sheikh-of-the-country.firebaseapp.com",
        projectId: "sheikh-of-the-country",
        storageBucket: "sheikh-of-the-country.firebasestorage.app",
        messagingSenderId: "767891906712",
        appId: "1:767891906712:web:1ee97ae642db1eb77b70ed",
        measurementId: "G-PLL1LDBRM1"
      };

      // تهيئة Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const analytics = getAnalytics(app);

      // تصدير الأدوات للـ window لتعمل مع بقية الكود في الأسفل
      window.db = db;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbPush = push;
      window.dbOnValue = onValue;
      window.dbUpdate = update;
      window.dbRemove = remove;

      console.log("تم ربط المطبخ بقاعدة البيانات بنجاح! ✅");
    </script>

    <style>
        :root { --blue: #18248b; --red: #8c0104; --white: #ffffff; --green: #27ae60; --gray: #f4f7f6; }
        body { font-family: 'Cairo', sans-serif; background: var(--gray); margin: 0; padding: 20px; }
        .header { background: var(--blue); color: white; padding: 15px 25px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 5px solid var(--red); }
        .orders-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 80vh; }
        .column { background: #ebedef; border-radius: 20px; padding: 15px; display: flex; flex-direction: column; }
        .column-header { padding: 15px; border-radius: 12px; margin-bottom: 15px; color: white; font-weight: bold; text-align: center; }
        .new-header { background: var(--red); }
        .prep-header { background: var(--blue); }
        .orders-list { flex: 1; overflow-y: auto; }
        .order-card { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; border-right: 8px solid #ccc; cursor: pointer; position: relative; }
        .order-card.priority { border-right-color: var(--red); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 20px; }
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-accept { background: var(--green); color: white; }
    </style>
</head>
<body>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.mp3" loop></audio>

    <div class="header">
        <h1>مطبخ شيخ البلد - استلام الطلبات</h1>
        <div id="connectionStatus"><i class="fas fa-circle" style="color: #2ecc71;"></i> متصل</div>
    </div>

    <div class="orders-container">
        <div class="column">
            <div class="column-header new-header">طلبات جديدة</div>
            <div id="newList" class="orders-list"></div>
        </div>
        <div class="column">
            <div class="column-header prep-header">جاري التحضير</div>
            <div id="prepList" class="orders-list"></div>
        </div>
    </div>

    <div class="modal" id="orderModal">
        <div class="modal-content" id="modalContent"></div>
    </div>

    <script>
        // كائن التعامل مع Firebase
        const DB = {
            update: (path, updates) => window.dbUpdate(window.dbRef(window.db, path), updates),
            listen: (path, callback) => window.dbOnValue(window.dbRef(window.db, path), (snap) => callback(snap.val() || {}))
        };

        let allOrdersData = {};

        // بدء الاستماع للطلبات في الوقت الفعلي
        setTimeout(() => {
            DB.listen('orders', (data) => {
                allOrdersData = data;
                renderOrders(data);
            });
        }, 2000); // تأخير بسيط لضمان تحميل المكتبات

        function renderOrders(data) {
            const newList = document.getElementById('newList');
            const prepList = document.getElementById('prepList');
            const alarm = document.getElementById('alarmSound');
            
            newList.innerHTML = ''; prepList.innerHTML = '';
            let hasNew = false;

            Object.entries(data).reverse().forEach(([id, order]) => {
                const card = `
                    <div class="order-card ${order.status === 'pending' || order.status === 'new' ? 'priority' : ''}" onclick="openOrder('${id}')">
                        <div style="font-weight:bold;">#${id.slice(-4)} - ${order.customerName}</div>
                        <div style="font-size:0.9rem; color:#666;">${order.items.map(i => i.name).join(', ')}</div>
                        <div style="text-align:left; color:var(--blue); font-weight:bold;">${order.total} ج</div>
                    </div>`;

                if (order.status === 'pending' || order.status === 'new') {
                    newList.innerHTML += card;
                    if (!order.seenByKitchen) hasNew = true;
                } else if (order.status === 'processing') {
                    prepList.innerHTML += card;
                }
            });

            if (hasNew) alarm.play().catch(() => {}); else { alarm.pause(); alarm.currentTime = 0; }
        }

        window.openOrder = function(id) {
            const order = allOrdersData[id];
            DB.update('orders/' + id, { seenByKitchen: true });

            const modal = document.getElementById('orderModal');
            document.getElementById('modalContent').innerHTML = `
                <h2>طلب #${id.slice(-4)}</h2>
                <p><b>العميل:</b> ${order.customerName} | ${order.phone}</p>
                <p><b>العنوان:</b> ${order.address}</p>
                <hr>
                ${order.items.map(i => `<div>${i.count}x ${i.name}</div>`).join('')}
                <h3 style="text-align:center;">الإجمالي: ${order.total} ج</h3>
                ${order.status !== 'processing' ? 
                    `<button class="btn-action btn-accept" onclick="changeStatus('${id}', 'processing')">بدء التحضير</button>` : 
                    `<button class="btn-action btn-accept" style="background:var(--blue)" onclick="changeStatus('${id}', 'completed')">تم التوصيل</button>`}
                <button class="btn-action" style="background:#ccc" onclick="document.getElementById('orderModal').style.display='none'">إغلاق</button>
            `;
            modal.style.display = 'flex';
        };

        window.changeStatus = function(id, status) {
            DB.update('orders/' + id, { status: status });
            document.getElementById('orderModal').style.display = 'none';
        };
    </script>
</body>
</html>
